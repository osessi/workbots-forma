// Prisma Schema - Automate Forma
// Multi-tenant SaaS pour organismes de formation

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================================
// ENUMS
// ===========================================

enum Plan {
  FREE
  STARTER
  PRO
  ENTERPRISE
}

enum UserRole {
  SUPER_ADMIN
  ORG_ADMIN
  FORMATEUR
  COLLABORATEUR
}

enum FormationStatus {
  BROUILLON
  EN_COURS
  TERMINEE
  ARCHIVEE
}

enum ApprenantStatus {
  SALARIE
  INDEPENDANT
  PARTICULIER
}

enum FinanceurType {
  OPCO
  AGEFIPH
  CAISSE_DEPOTS
  ETAT
  FOND_ASSURANCE
  FRANCE_TRAVAIL
  INSTANCES_EUROPEENNES
  OPACIF
  OPCA
  REGION
  ORGANISME_PUBLIC
  AUTRE
}

enum SessionModalite {
  PRESENTIEL // Formation en présentiel
  DISTANCIEL // Formation à distance synchrone
  MIXTE // Combinaison présentiel et distanciel
  E_LEARNING // Formation en ligne asynchrone
  SITUATION_TRAVAIL // Formation en situation de travail (AFEST)
  STAGE // Stage pratique
}

enum SessionStatus {
  BROUILLON // Session créée mais pas finalisée
  PLANIFIEE // Session planifiée, en attente de démarrage
  EN_COURS // Session en cours de réalisation
  TERMINEE // Session terminée
  ANNULEE // Session annulée
}

enum EvaluationType {
  POSITIONNEMENT // Test de positionnement (avant formation)
  FINALE // Évaluation finale (fin de formation)
  QCM_MODULE // QCM par module
  ATELIER_MODULE // Atelier pratique par module
}

enum CreationMode {
  AI // Création avec IA
  MANUAL // Création manuelle (sans IA)
  IMPORT // Import d'une formation existante
}

enum TypeLieu {
  PRESENTIEL
  VISIOCONFERENCE
}

enum FileCategory {
  FICHE_PEDAGOGIQUE
  SLIDES
  DOCUMENT
  EVALUATION
  SUPPORT_STAGIAIRE
  IMAGE
  AUTRE
}

enum SlideGenerationStatus {
  PENDING
  ENRICHMENT
  GENERATING
  FINALIZING
  COMPLETED
  FAILED
}

enum DocumentType {
  FICHE_PEDAGOGIQUE
  PROGRAMME_FORMATION
  CONVENTION
  CONTRAT_FORMATION
  CONVOCATION
  ATTESTATION_PRESENCE
  ATTESTATION_FIN
  EVALUATION_CHAUD
  EVALUATION_FROID
  REGLEMENT_INTERIEUR
  CERTIFICAT
  DEVIS
  FACTURE
  CONDITIONS_GENERALES_VENTE
  CONTRAT_SOUS_TRAITANCE
  EVALUATION_INTERVENANT
  EVALUATION_ENTREPRISE
  EVALUATION_FINANCEUR
  FEUILLE_EMARGEMENT
  // Procédures Qualiopi IND 26
  PROCEDURE_ACCUEIL
  PROCEDURE_RECLAMATIONS
  PROCEDURE_EVALUATION
  PROCEDURE_SOUS_TRAITANCE
  PROCEDURE_VEILLE
  PROCEDURE_ACCESSIBILITE
  PROCEDURE_SUIVI_STAGIAIRES
  PROCEDURE_GESTION_COMPETENCES
  AUTRE
}

// Types de procédures Qualiopi IND 26
enum ProcedureType {
  ACCUEIL // Procédure d'accueil des stagiaires
  RECLAMATIONS // Procédure de gestion des réclamations
  EVALUATION // Procédure d'évaluation
  SOUS_TRAITANCE // Procédure de sous-traitance
  VEILLE // Procédure de veille
  ACCESSIBILITE // Procédure d'accessibilité handicap
  SUIVI_STAGIAIRES // Procédure de suivi des stagiaires
  GESTION_COMPETENCES // Procédure de gestion des compétences
  PERSONNALISEE // Procédure personnalisée
}

enum TemplateCategory {
  DOCUMENT
  EMAIL
  PDF
}

// ===========================================
// ENUMS QUALIOPI
// ===========================================

// Statut d'un indicateur Qualiopi
enum IndicateurStatus {
  CONFORME          // Indicateur conforme
  NON_CONFORME      // Indicateur non conforme
  EN_COURS          // En cours de mise en conformité
  NON_APPLICABLE    // Non applicable à l'organisme
  A_EVALUER         // À évaluer
}

// Type d'alerte Qualiopi
enum AlerteQualiopiType {
  DOCUMENT_MANQUANT       // Document obligatoire manquant
  DOCUMENT_EXPIRE         // Document expiré
  INDICATEUR_NON_CONFORME // Indicateur non conforme
  AUDIT_PROCHE            // Audit approchant
  ACTION_EN_RETARD        // Action corrective en retard
  MISE_A_JOUR_REQUISE     // Mise à jour requise
}

// Priorité d'une alerte
enum AlertePriorite {
  BASSE
  MOYENNE
  HAUTE
  CRITIQUE
}

// Statut d'une action corrective
enum ActionCorrectiveStatus {
  A_FAIRE
  EN_COURS
  TERMINEE
  ANNULEE
}

// Type d'audit
enum AuditType {
  INITIAL        // Premier audit de certification
  SURVEILLANCE   // Audit de surveillance
  RENOUVELLEMENT // Audit de renouvellement
  SIMULATION     // Simulation interne
}

// Résultat d'audit
enum AuditResultat {
  EN_ATTENTE
  REUSSI
  ECHOUE
  PARTIEL
}

// ===========================================
// ORGANISATIONS (Multi-tenant root)
// ===========================================

model Organization {
  id   String @id @default(cuid())
  name String
  slug String @unique
  plan Plan   @default(FREE)

  // Infos entreprise
  nomCommercial    String? // Nom commercial de l'organisme
  siret            String?
  villeRcs         String? // Ville d'immatriculation au RCS
  numeroFormateur  String? // N° déclaration d'activité DREETS
  prefectureRegion String? // Région d'acquisition du numéro de déclaration
  adresse          String?
  codePostal       String?
  ville            String?
  telephone        String?
  email            String? // Email de contact de l'organisme
  siteWeb          String? // Site web de l'organisme

  // Représentant légal
  representantLegal    String? // DEPRECATED - Ancien champ nom complet
  representantNom      String? // Nom du représentant légal
  representantPrenom   String? // Prénom du représentant légal
  representantFonction String? // Fonction du représentant légal (ex: Gérant, PDG)

  // White-label & Visuels
  logo           String? // Logo de l'organisme
  signature      String? // URL de l'image de signature du responsable
  cachet         String? // URL du cachet de l'entreprise
  primaryColor   String  @default("#4277FF")
  secondaryColor String?
  customDomain   String? @unique

  // Limites selon plan
  maxFormateurs Int @default(1)
  maxFormations Int @default(5)
  maxStorageGb  Int @default(1)

  // Stripe
  stripeCustomerId     String? @unique
  stripeSubscriptionId String?

  // APIs externes (clés optionnelles par organisation)
  gammaApiKey String? // Clé API Gamma pour génération slides

  // Metadata
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users            User[]
  formations       Formation[]
  files            File[]
  templates        Template[]
  apiKeys          ApiKey[]
  serviceApiKeys   ServiceApiKey[]
  auditLogs        AuditLog[]
  aiPrompts        AIPrompt[]
  aiGenerationLogs AIGenerationLog[]
  reusableBlocks   ReusableBlock[]
  customVariables  CustomVariable[]

  // BDD - Mes données
  entreprises    Entreprise[]
  apprenants     Apprenant[]
  intervenants   Intervenant[]
  lieuxFormation LieuFormation[]
  financeurs     Financeur[]

  // Sessions documentaires (ancien système)
  documentSessions DocumentSession[]

  // Sessions (nouveau système)
  sessions Session[]

  // CRM
  opportunites CRMOpportunite[]

  // Signature électronique
  signatureDocuments SignatureDocument[]

  // SCORM LMS
  scormPackages SCORMPackage[]

  // Qualiopi - Pré-inscriptions
  preInscriptions PreInscription[]

  // Qualiopi - Champs catalogue public (Indicateur 1)
  catalogueActif           Boolean  @default(false) // Catalogue public activé
  categorieOF              String? // Catégorie de l'OF
  certifications           String[] // Certifications (Qualiopi, etc.)
  mentionsLegalesCatalogue String?  @db.Text // Mentions légales spécifiques au catalogue
  certificatQualiopiUrl    String? // URL du certificat Qualiopi (PDF uploadé)
  categorieQualiopi        String? // Catégorie Qualiopi (ex: "Actions de formation")

  // Notifications
  notifications Notification[]

  // Évaluations de satisfaction (Qualiopi IND 2)
  evaluationsSatisfaction EvaluationSatisfaction[]
  evaluationsIntervenant  EvaluationIntervenant[]

  // Organigramme (Qualiopi IND 9)
  organigrammePostes OrganigrammePoste[]

  // Qualiopi IND 17 - Fiches mission intervenants
  fichesMission FicheMissionIntervenant[]

  // Qualiopi IND 23, 24, 25 - Veille réglementaire
  veilleSources         VeilleSource[]
  veilleArticleLectures VeilleArticleLecture[]
  veilleConversations   VeilleConversation[]

  // Qualiopi IND 26 - Procédures qualité
  procedures Procedure[]

  // Qualiopi IND 31 - Réclamations
  reclamations Reclamation[]

  // Qualiopi IND 32 - Améliorations
  ameliorations ActionAmelioration[]

  // Module 6 - Moteur d'automatisation
  workflows              Workflow[]
  workflowEmailTemplates WorkflowEmailTemplate[]
  workflowSMSTemplates   WorkflowSMSTemplate[]

  // Module 7 & 8 - Qualiopi & Agent IA
  auditsQualiopi         AuditQualiopi[]
  indicateursConformite  IndicateurConformite[]
  alertesQualiopi        AlerteQualiopi[]
  conversationsQualiopi  ConversationQualiopi[]
  bilansFinanciers       BilanPedagogiqueFinancier[]

  @@index([slug])
  @@index([customDomain])
}

// ===========================================
// UTILISATEURS
// ===========================================

model User {
  id         String   @id @default(cuid())
  supabaseId String   @unique // ID Supabase Auth (remplace clerkId)
  email      String   @unique
  firstName  String?
  lastName   String?
  phone      String?
  avatar     String?
  role       UserRole @default(FORMATEUR)

  // Multi-tenant
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Super Admin uniquement
  isSuperAdmin Boolean @default(false)

  // Metadata
  isActive    Boolean   @default(true)
  lastLoginAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  formations       Formation[]
  files            File[]
  sessions         FormationSession[]
  auditLogs        AuditLog[]
  aiGenerationLogs AIGenerationLog[]
  templateVersions TemplateVersion[]  @relation("TemplateVersionCreator")
  opportunites     CRMOpportunite[]
  notifications    Notification[]

  // Qualiopi IND 5 - Notes créées
  apprenantNotes ApprenantNote[] @relation("ApprenantNoteCreatedBy")

  // Qualiopi IND 23, 24, 25 - Veille réglementaire
  veilleArticleLectures VeilleArticleLecture[]
  veilleConversations   VeilleConversation[]

  // Module 7 & 8 - Qualiopi & Agent IA
  actionsCorrectivesResponsable ActionCorrective[]
  conversationsQualiopi         ConversationQualiopi[]

  @@index([supabaseId])
  @@index([organizationId])
  @@index([email])
}

// ===========================================
// FORMATIONS
// ===========================================

model Formation {
  id          String          @id @default(cuid())
  titre       String
  description String?         @db.Text
  image       String?
  status      FormationStatus @default(BROUILLON)

  // Mode de création (avec/sans IA, import)
  creationMode CreationMode @default(AI)

  // Multi-tenant
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Créateur
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Étape courante du wizard (persistance navigation)
  currentStep    String   @default("contexte") // contexte, fiche, slides, evaluations
  completedSteps String[] @default([])

  // Données du contexte (étape 1)
  contexteData Json?

  // Fiche pédagogique (JSON) - étape 2
  fichePedagogique Json?

  // Slides générés (Gamma) - étape 3
  slidesGenerated   Boolean   @default(false)
  slidesData        Json? // URLs et infos des slides par module
  slidesGeneratedAt DateTime?

  // Évaluations générées (JSON) - étape 4 - DEPRECATED: Migrer vers Evaluation model
  evaluationsData Json? // QCMs, positionnement, évaluations finales

  // Documents générés (JSON) - DEPRECATED: Maintenant géré dans Session
  documentsData Json? // Documents générés dans le wizard (conventions, contrats, etc.)

  // Statistiques dénormalisées (calculées)
  totalSessions   Int       @default(0)
  totalApprenants Int       @default(0)
  lastSessionDate DateTime?

  // Metadata
  isArchived  Boolean   @default(false)
  isPublished Boolean   @default(false) // Publié dans le LMS
  publishedAt DateTime? // Date de publication
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  modules          Module[]
  evaluations      Evaluation[] // NEW: Évaluations persistées
  documents        Document[]
  sessions         FormationSession[] // Legacy - à supprimer
  trainingSessions Session[] // NEW: Sessions de formation
  files            File[]
  documentSessions DocumentSession[] // Legacy - migrer vers Session
  folder           Folder?            @relation("FormationFolder")
  slideGenerations SlideGeneration[]
  opportunites     CRMOpportunite[]
  lmsInscriptions  LMSInscription[]
  scormPackages    SCORMPackage[]

  // Qualiopi - Pré-inscriptions et Indicateurs
  preInscriptions PreInscription[]
  indicateurs     FormationIndicateurs?

  // Qualiopi IND 17 - Fiches mission intervenants
  fichesMission FicheMissionIntervenant[] @relation("FicheMissionFormation")

  // Qualiopi - Indicateur 3 : Formation certifiante
  isCertifiante         Boolean @default(false)
  numeroFicheRS         String? // Numéro de fiche RS (ex: RS6563)
  referentielRSUrl      String? // URL du fichier référentiel uploadé
  lienFranceCompetences String? // Lien vers la fiche France Compétences

  // Qualiopi - Catalogue public
  estPublieCatalogue    Boolean @default(false) // Visible dans le catalogue public
  tarifAffiche          Float? // Tarif affiché dans le catalogue
  publicVise            String? @db.Text // Public visé
  prerequis             String? @db.Text // Prérequis
  accessibiliteHandicap String? @db.Text // Informations accessibilité handicap
  delaiAcces            String? // Délai d'accès (ex: "2 semaines")
  modalitesEvaluation   String? @db.Text // Modalités d'évaluation

  // CPF - Éligibilité
  estEligibleCPF     Boolean @default(false) // Éligible au CPF
  codeFinancementCPF String? // Code de financement CPF

  // Qualiopi IND 31 & 32 - Réclamations et Améliorations
  reclamations  Reclamation[]
  ameliorations ActionAmelioration[]

  @@index([organizationId])
  @@index([userId])
  @@index([status])
  @@index([creationMode])
}

model Module {
  id          String  @id @default(cuid())
  titre       String
  description String? @db.Text
  ordre       Int     @default(0)
  duree       Int? // en minutes

  // Qualiopi IND 10 - Module 0 mise à niveau
  isModuleZero Boolean @default(false) // Module de mise à niveau (non comptabilisé dans durée totale)

  // Parent
  formationId String
  formation   Formation @relation(fields: [formationId], references: [id], onDelete: Cascade)

  // Contenu (JSON pour flexibilité)
  contenu Json?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations LMS
  lmsProgressions LMSProgressionModule[]

  @@index([formationId])
  @@index([ordre])
  @@index([isModuleZero])
}

// ===========================================
// GÉNÉRATION DE SLIDES (Workbots AI)
// ===========================================

model SlideGeneration {
  id String @id @default(cuid())

  // Formation parent
  formationId String
  formation   Formation @relation(fields: [formationId], references: [id], onDelete: Cascade)

  // Statut global
  status   SlideGenerationStatus @default(PENDING)
  progress Int                   @default(0) // 0-100

  // Phase actuelle
  currentPhase       String? // enrichment, generation, finalizing
  currentModuleIndex Int     @default(0)
  currentModuleName  String?

  // Options utilisées
  themeId        String?
  themeName      String?
  tone           String?
  cardsPerModule Int     @default(10)

  // Erreur éventuelle
  errorMessage String?

  // Résultats par module
  moduleResults Json? // Array des résultats de chaque module

  // Utilisateur qui a lancé
  userId String

  // Metadata
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([formationId])
  @@index([userId])
  @@index([status])
}

// ===========================================
// DOCUMENTS GÉNÉRÉS
// ===========================================

model Document {
  id    String       @id @default(cuid())
  type  DocumentType
  titre String

  // Contenu WYSIWYG (TipTap JSON)
  content Json?

  // Fichier généré
  fileUrl  String?
  fileSize Int?

  // Parent
  formationId String
  formation   Formation @relation(fields: [formationId], references: [id], onDelete: Cascade)

  // Template utilisé
  templateId String?
  template   Template? @relation(fields: [templateId], references: [id])

  // Metadata
  version     Int       @default(1)
  isGenerated Boolean   @default(false)
  generatedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([formationId])
  @@index([type])
}

// ===========================================
// TEMPLATES (Documents modèles)
// ===========================================

model Template {
  id           String           @id @default(cuid())
  name         String
  description  String?
  category     TemplateCategory
  documentType DocumentType?

  // Contenu WYSIWYG (TipTap JSON)
  content       Json
  // Header du document (logo, coordonnees, etc.)
  headerContent Json?
  // Footer du document (mentions legales, pagination, etc.)
  footerContent Json?

  // Variables disponibles (ex: ["formation.titre", "formateur.nom"])
  variables String[]

  // Multi-tenant (null = template système)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Template système (disponible pour tous)
  isSystem Boolean @default(false)

  // Metadata
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  documents  Document[]
  procedures Procedure[]

  @@index([organizationId])
  @@index([category])
  @@index([isSystem])
}

// ===========================================
// FICHIERS (File Manager)
// ===========================================

model File {
  id           String       @id @default(cuid())
  name         String
  originalName String
  mimeType     String
  size         Int // en bytes
  category     FileCategory

  // Stockage Supabase
  storagePath String
  publicUrl   String?

  // Multi-tenant
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Uploader
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Lien optionnel avec formation
  formationId String?
  formation   Formation? @relation(fields: [formationId], references: [id], onDelete: SetNull)

  // Dossier virtuel
  folderId String?
  folder   Folder? @relation(fields: [folderId], references: [id], onDelete: SetNull)

  // Contenu du fichier (pour les documents HTML éditables)
  fileContent FileContent?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([userId])
  @@index([category])
  @@index([folderId])
}

// Contenu des fichiers HTML éditables
model FileContent {
  id        String   @id @default(cuid())
  fileId    String   @unique
  file      File     @relation(fields: [fileId], references: [id], onDelete: Cascade)
  content   String   @db.Text // Contenu HTML
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Folder {
  id    String @id @default(cuid())
  name  String
  color String @default("#4277FF")

  // Parent folder (pour hiérarchie)
  parentId String?
  parent   Folder?  @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children Folder[] @relation("FolderHierarchy")

  // Lien avec formation (dossier racine de la formation)
  formationId String?    @unique
  formation   Formation? @relation("FormationFolder", fields: [formationId], references: [id], onDelete: Cascade)

  // Lien avec entreprise (sous-dossier entreprise dans une formation)
  entrepriseId String?
  entreprise   Entreprise? @relation(fields: [entrepriseId], references: [id], onDelete: SetNull)

  // Lien avec apprenant (sous-dossier apprenant)
  apprenantId String?
  apprenant   Apprenant? @relation(fields: [apprenantId], references: [id], onDelete: SetNull)

  // Type de dossier pour faciliter le filtrage
  folderType String @default("general") // formation, entreprise, apprenant, general

  // Multi-tenant
  organizationId String

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  files File[]

  @@index([organizationId])
  @@index([parentId])
  @@index([formationId])
  @@index([entrepriseId])
  @@index([apprenantId])
  @@index([folderType])
}

// ===========================================
// SESSIONS DE FORMATION
// ===========================================

model FormationSession {
  id String @id @default(cuid())

  // Parent
  formationId String
  formation   Formation @relation(fields: [formationId], references: [id], onDelete: Cascade)

  // Formateur assigné
  formateurId String
  formateur   User   @relation(fields: [formateurId], references: [id])

  // Dates
  dateDebut DateTime
  dateFin   DateTime

  // Lieu
  lieu         String?
  isDistanciel Boolean @default(false)
  lienVisio    String?

  // Participants
  maxParticipants Int @default(10)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  participants Participant[]

  @@index([formationId])
  @@index([formateurId])
  @@index([dateDebut])
}

model Participant {
  id String @id @default(cuid())

  // Session
  sessionId String
  session   FormationSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Infos participant
  email     String
  firstName String
  lastName  String
  company   String?

  // Statut
  hasConfirmed Boolean @default(false)
  hasAttended  Boolean @default(false)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sessionId])
  @@index([email])
}

// ===========================================
// API KEYS (Pour intégrations)
// ===========================================

model ApiKey {
  id   String @id @default(cuid())
  name String
  key  String @unique

  // Multi-tenant
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Permissions (JSON array de scopes)
  scopes String[]

  // Limites
  rateLimit Int @default(1000) // requêtes par heure

  // Metadata
  lastUsedAt DateTime?
  expiresAt  DateTime?
  isActive   Boolean   @default(true)
  createdAt  DateTime  @default(now())

  @@index([key])
  @@index([organizationId])
}

// ===========================================
// SERVICE API KEYS (Clés des services externes)
// ===========================================

model ServiceApiKey {
  id           String @id @default(cuid())
  name         String // Nom pour identification
  provider     String // ANTHROPIC, OPENAI, GAMMA, SUPABASE, RESEND
  encryptedKey String // Clé chiffrée

  // Global ou par organisation
  isGlobal       Boolean       @default(false)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Metadata
  isActive   Boolean   @default(true)
  lastUsedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([provider])
  @@index([organizationId])
  @@index([isGlobal])
}

// ===========================================
// GLOBAL SETTINGS (Paramètres globaux)
// ===========================================

model GlobalSettings {
  id        String   @id @default(cuid())
  data      Json // Stockage flexible des paramètres
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ===========================================
// AUDIT LOG (Traçabilité)
// ===========================================

model AuditLog {
  id String @id @default(cuid())

  // Action
  action   String // CREATE, UPDATE, DELETE, LOGIN, etc.
  entity   String // Formation, Document, etc.
  entityId String?

  // Détails (JSON)
  details Json?

  // Qui
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Multi-tenant
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  // IP & metadata
  ipAddress String?
  userAgent String?

  // Timestamp
  createdAt DateTime @default(now())

  @@index([organizationId])
  @@index([userId])
  @@index([action])
  @@index([entity])
  @@index([createdAt])
}

// ===========================================
// INVITATIONS
// ===========================================

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

model Invitation {
  id     String           @id @default(cuid())
  email  String
  role   UserRole         @default(FORMATEUR)
  status InvitationStatus @default(PENDING)
  token  String           @unique

  // Multi-tenant
  organizationId String

  // Qui a invité
  invitedById String

  // Expiration (7 jours par défaut)
  expiresAt DateTime

  // Metadata
  createdAt  DateTime  @default(now())
  acceptedAt DateTime?

  @@index([organizationId])
  @@index([email])
  @@index([token])
  @@index([status])
}

// ===========================================
// CONFIG GLOBALE (Super Admin)
// ===========================================

model GlobalConfig {
  id          String  @id @default(cuid())
  key         String  @unique
  value       Json
  description String?

  // Metadata
  updatedAt DateTime @updatedAt

  @@index([key])
}

// ===========================================
// AI PROMPTS (Prompts IA configurables)
// ===========================================

enum AIPromptType {
  FICHE_PEDAGOGIQUE
  PROGRAMME_FORMATION
  CONVENTION
  CONTRAT_FORMATION
  CONVOCATION
  ATTESTATION_PRESENCE
  ATTESTATION_FIN
  EVALUATION_CHAUD
  EVALUATION_FROID
  REGLEMENT_INTERIEUR
  CERTIFICAT
  QCM
  POSITIONNEMENT
  EVALUATION_FINALE
  REFORMULATION
  MODULE_ZERO // Qualiopi IND 10 - Module 0 mise à niveau
  FICHE_ADAPTABILITE // Qualiopi IND 10 - Fiche d'adaptabilité du parcours
  CORRELATION_OBJECTIFS // Qualiopi IND 11 - Corrélation objectifs/évaluation finale
  CUSTOM
}

model AIPrompt {
  id          String       @id @default(cuid())
  name        String
  description String?
  type        AIPromptType

  // Prompt system (instructions pour l'IA)
  systemPrompt String @db.Text

  // Prompt utilisateur (template avec variables)
  userPromptTemplate String @db.Text

  // Variables requises pour ce prompt (ex: ["formation.titre", "modules"])
  requiredVariables String[]

  // Variables optionnelles
  optionalVariables String[]

  // Configuration IA
  model       String @default("claude-sonnet-4-20250514")
  temperature Float  @default(0.7)
  maxTokens   Int    @default(4096)

  // Schema de sortie attendu (JSON Schema pour validation)
  outputSchema Json?

  // Template TipTap pour formater la sortie (optionnel)
  outputTemplate Json?

  // Prompt systeme (global uniquement)
  isSystem Boolean @default(false)

  // Multi-tenant (null = global)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relation avec les logs
  generationLogs AIGenerationLog[]

  // Metadata
  isActive  Boolean  @default(true)
  version   Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([type, organizationId])
  @@index([type])
  @@index([organizationId])
  @@index([isSystem])
}

// ===========================================
// BLOCS REUTILISABLES (Bibliotheque)
// ===========================================

model ReusableBlock {
  id          String  @id @default(cuid())
  name        String
  description String?

  // Contenu WYSIWYG (TipTap JSON)
  content Json

  // Categorie pour organisation
  category String @default("general") // mentions_legales, cgv, signature, header, footer, general

  // Tags pour recherche
  tags String[]

  // Multi-tenant (null = bloc systeme)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Bloc systeme (disponible pour tous)
  isSystem Boolean @default(false)

  // Metadata
  isActive   Boolean  @default(true)
  usageCount Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([organizationId])
  @@index([category])
  @@index([isSystem])
  @@index([tags])
}

// ===========================================
// HISTORIQUE DES VERSIONS DE TEMPLATES
// ===========================================

model TemplateVersion {
  id String @id @default(cuid())

  // Template parent
  templateId String

  // Numero de version
  version Int

  // Contenu au moment de la version
  content       Json
  headerContent Json?
  footerContent Json?

  // Commentaire de version (optionnel)
  changeNote String?

  // Qui a cree cette version
  createdById String?
  createdBy   User?   @relation("TemplateVersionCreator", fields: [createdById], references: [id])

  // Metadata
  createdAt DateTime @default(now())

  @@unique([templateId, version])
  @@index([templateId])
  @@index([createdAt])
  @@index([createdById])
}

// ===========================================
// VARIABLES PERSONNALISEES PAR ORGANISATION
// ===========================================

model CustomVariable {
  id String @id @default(cuid())

  // Identifiant de la variable (ex: "organisation.certification_qualiopi")
  variableId String

  // Nom affiche
  label String

  // Description
  description String?

  // Categorie
  category String @default("organisation")

  // Valeur par defaut
  defaultValue String?

  // Type de donnee (text, number, date, boolean, image)
  dataType String @default("text")

  // Multi-tenant
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Metadata
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, variableId])
  @@index([organizationId])
  @@index([category])
}

// ===========================================
// AI GENERATION LOGS (Suivi des generations)
// ===========================================

model AIGenerationLog {
  id String @id @default(cuid())

  // Quel prompt a ete utilise
  promptId   String?
  prompt     AIPrompt?    @relation(fields: [promptId], references: [id], onDelete: SetNull)
  promptType AIPromptType

  // Qui a genere
  userId         String
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  // Input/Output
  inputContext  Json // Contexte envoye a l'IA
  outputContent Json? // Contenu genere
  outputRaw     String? @db.Text // Reponse brute de l'IA

  // Metriques
  tokensPrompt     Int @default(0)
  tokensCompletion Int @default(0)
  tokensTotal      Int @default(0)
  durationMs       Int @default(0)

  // Statut
  status       String  @default("pending") // pending, success, error
  errorMessage String?

  // Provider utilise
  provider String? // anthropic, openai
  model    String?

  // Metadata
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([organizationId])
  @@index([promptType])
  @@index([status])
  @@index([createdAt])
}

// ===========================================
// BASE DE DONNEES - MES DONNEES
// ===========================================

// Entreprises clientes de l'OF
model Entreprise {
  id String @id @default(cuid())

  // Infos principales
  raisonSociale String
  siret         String?
  tvaIntracom   String?

  // Représentant légal
  contactCivilite  String? // Civilité du représentant (M., Mme)
  contactNom       String?
  contactPrenom    String?
  contactFonction  String? // Fonction du représentant légal
  contactEmail     String?
  contactTelephone String?

  // Adresse
  adresse    String?
  codePostal String?
  ville      String?
  pays       String  @default("France")

  // Notes internes
  notes String? @db.Text

  // Multi-tenant
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Metadata
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  apprenants         Apprenant[]
  sessionClients     SessionClient[]
  folders            Folder[]
  opportunites       CRMOpportunite[]
  signatureDocuments SignatureDocument[]

  // Nouveau système de sessions
  sessionsClientNew SessionClientNew[] @relation("SessionClientEntreprise")

  @@index([organizationId])
  @@index([raisonSociale])
  @@index([siret])
}

// Apprenants / Participants
model Apprenant {
  id String @id @default(cuid())

  // Infos personnelles
  nom       String
  prenom    String
  email     String
  telephone String?

  // Infos indépendant (si statut = INDEPENDANT)
  raisonSociale String? // Raison sociale de l'apprenant indépendant
  siret         String? // Numéro SIRET de l'apprenant indépendant

  // Adresse
  adresse    String?
  codePostal String?
  ville      String?
  pays       String  @default("France")

  // Statut
  statut ApprenantStatus @default(PARTICULIER)

  // Si salarié, entreprise rattachée
  entrepriseId String?
  entreprise   Entreprise? @relation(fields: [entrepriseId], references: [id], onDelete: SetNull)

  // Notes internes
  notes String? @db.Text

  // Multi-tenant
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Metadata
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  sessionParticipants SessionParticipant[]
  folders             Folder[]
  lmsInscriptions     LMSInscription[]
  signatureDocuments  SignatureDocument[]
  scormTrackings      SCORMTracking[]

  // Nouveau système de sessions
  sessionParticipationsNew SessionParticipantNew[] @relation("SessionParticipantApprenant")
  evaluationResultats      EvaluationResultat[]    @relation("EvaluationResultatApprenant")

  // Qualiopi - Pré-inscriptions converties
  preInscriptions PreInscription[]

  // Authentification apprenant (Magic Code)
  authCodes    ApprenantAuthCode[]
  inviteTokens ApprenantInviteToken[]

  // Évaluations de satisfaction (Qualiopi IND 2)
  evaluationsSatisfaction EvaluationSatisfaction[] @relation("EvaluationSatisfactionApprenant")

  // Qualiopi IND 5 - Historique des notes internes
  notesHistory ApprenantNote[]
  reclamations Reclamation[]

  @@index([organizationId])
  @@index([entrepriseId])
  @@index([statut])
  @@index([email])
}

// Qualiopi IND 5 - Historique des notes internes pour les apprenants
model ApprenantNote {
  id String @id @default(cuid())

  // Apprenant parent
  apprenantId String
  apprenant   Apprenant @relation(fields: [apprenantId], references: [id], onDelete: Cascade)

  // Contenu de la note
  content String @db.Text

  // Qui a ajouté cette note
  createdById String?
  createdBy   User?   @relation("ApprenantNoteCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  // Timestamps
  createdAt DateTime @default(now())

  @@index([apprenantId])
  @@index([createdAt])
  @@index([createdById])
}

// Intervenants / Formateurs
model Intervenant {
  id String @id @default(cuid())

  // Infos personnelles
  nom       String
  prenom    String
  email     String?
  telephone String?

  // Photo de profil (Qualiopi IND 17)
  photoUrl String?

  // Fonction / spécialité
  fonction    String?
  specialites String[]

  // Qualiopi IND 17 - Compétences et qualifications
  cv               String? // URL du CV téléchargé
  biographie       String? @db.Text // Biographie professionnelle
  anneesExperience Int? // Années d'expérience

  // Numéro de déclaration d'activité (pour formateurs indépendants)
  numeroDeclarationActivite String?

  // Structure (si externe)
  structure      String?
  structureSiret String?

  // Notes internes
  notes String? @db.Text

  // Multi-tenant
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Metadata
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  sessionsFormateur    DocumentSession[]     @relation("SessionFormateur")
  sessionsCoFormateur  SessionCoFormateur[]
  signaturesEmargement SignatureEmargement[]

  // Nouveau système de sessions
  sessionsFormateurNew    Session[]                @relation("SessionFormateurPrincipal")
  sessionsCoFormateurNew  SessionCoFormateurNew[]  @relation("SessionCoFormateurIntervenant")
  signaturesEmargementNew SignatureEmargementNew[] @relation("SignatureEmargementFormateur")

  // Auth codes pour connexion OTP
  authCodes IntervenantAuthCode[]

  // Évaluations intervenant (Qualiopi IND 2)
  evaluationsIntervenant EvaluationIntervenant[] @relation("EvaluationIntervenantIntervenant")

  // Organigramme (Qualiopi IND 9)
  organigrammePostes OrganigrammePoste[] @relation("OrganigrammeIntervenant")

  // Diplômes et certifications (Qualiopi IND 17)
  diplomes IntervenantDiplome[]

  // Fiches mission (Qualiopi IND 17)
  fichesMission FicheMissionIntervenant[]

  @@index([organizationId])
  @@index([nom])
  @@index([email])
}

// Lieux de formation
model LieuFormation {
  id String @id @default(cuid())

  // Type de lieu
  typeLieu TypeLieu @default(PRESENTIEL)

  // Infos lieu
  nom           String // Nom du lieu de formation
  lieuFormation String // Adresse OU lien de visio selon typeLieu
  codePostal    String?
  ville         String?

  // Infos pratiques
  infosPratiques String? @db.Text // Code porte, étage, etc.

  // Capacité (seulement pour présentiel)
  capacite Int?

  // ===========================================
  // Checklist conformité lieu (Qualiopi IND 17)
  // ===========================================
  // Surface et aménagement
  checkSurfaceAdaptee Boolean @default(false) // Surface adaptée au nombre d'apprenants
  checkErpConforme    Boolean @default(false) // Conformité ERP (Établissement Recevant du Public)

  // Conditions de travail
  checkVentilation Boolean @default(false) // Ventilation/climatisation adaptée
  checkEclairage   Boolean @default(false) // Éclairage suffisant
  checkSanitaires  Boolean @default(false) // Sanitaires accessibles

  // Accessibilité
  checkAccessibiliteHandicap Boolean @default(false) // Accessibilité PMR

  // Équipements techniques
  checkWifi            Boolean @default(false) // WiFi disponible
  checkVideoprojecteur Boolean @default(false) // Vidéoprojecteur ou écran
  checkMobilier        Boolean @default(false) // Mobilier adapté (tables, chaises)
  checkEquipements     Boolean @default(false) // Équipements spécifiques selon formation
  checkFournitures     Boolean @default(false) // Fournitures pédagogiques

  // Notes sur la conformité
  notesConformite String? @db.Text

  // Multi-tenant
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Metadata
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  sessions DocumentSession[]

  // Nouveau système de sessions
  sessionsNew Session[] @relation("SessionLieu")

  @@index([organizationId])
  @@index([nom])
}

// ===========================================
// QUALIOPI IND 17 - MOBILISATION DES INTERVENANTS
// ===========================================

// Diplômes et certifications des intervenants
model IntervenantDiplome {
  id String @id @default(cuid())

  // Intervenant
  intervenantId String
  intervenant   Intervenant @relation(fields: [intervenantId], references: [id], onDelete: Cascade)

  // Informations du diplôme
  intitule       String // Titre du diplôme ou certification
  organisme      String? // Organisme délivrant le diplôme
  anneeObtention Int? // Année d'obtention
  niveau         String? // Niveau (Bac, Bac+2, Bac+5, etc.)
  fichierUrl     String? // URL du fichier justificatif

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([intervenantId])
}

// Fiche mission intervenant (pour chaque session)
model FicheMissionIntervenant {
  id String @id @default(cuid())

  // Intervenant concerné
  intervenantId String
  intervenant   Intervenant @relation(fields: [intervenantId], references: [id], onDelete: Cascade)

  // Session concernée
  sessionId String
  session   Session @relation("FicheMissionSession", fields: [sessionId], references: [id], onDelete: Cascade)

  // Formation (pour faciliter les requêtes)
  formationId String
  formation   Formation @relation("FicheMissionFormation", fields: [formationId], references: [id], onDelete: Cascade)

  // Contenu de la mission
  objectifsMission  String? @db.Text // Objectifs spécifiques de la mission
  publicVise        String? // Public visé
  dureeIntervention Int? // Durée en minutes
  moyensUtilises    String? @db.Text // Moyens pédagogiques et techniques

  // Signature
  signatureIntervenant   String? // Signature base64
  dateSignature          DateTime?
  signatureOrganisme     String? // Signature de l'organisme
  dateSignatureOrganisme DateTime?

  // Statut
  status FicheMissionStatus @default(DRAFT)

  // Multi-tenant
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([intervenantId, sessionId])
  @@index([intervenantId])
  @@index([sessionId])
  @@index([formationId])
  @@index([organizationId])
}

enum FicheMissionStatus {
  DRAFT // Brouillon
  SENT // Envoyée à l'intervenant
  SIGNED_INTERVENANT // Signée par l'intervenant
  SIGNED_BOTH // Signée par les deux parties
  CANCELLED // Annulée
}

// Financeurs (OPCO et autres)
model Financeur {
  id String @id @default(cuid())

  // Infos
  nom  String
  type FinanceurType @default(OPCO)

  // Contact (facultatif)
  email     String?
  telephone String?

  // Adresse
  adresse    String?
  codePostal String?
  ville      String?
  pays       String  @default("France")
  siteWeb    String?

  // Notes
  notes String? @db.Text

  // Multi-tenant
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Metadata
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  clientFinancements SessionClientFinancement[]

  // Nouveau système de sessions
  sessionFinancementsNew SessionFinancementNew[] @relation("SessionFinanceur")

  @@index([organizationId])
  @@index([nom])
  @@index([type])
}

// ===========================================
// WIZARD DOCUMENTS - SESSION DOCUMENTAIRE
// ===========================================

// Session documentaire liée à une formation
model DocumentSession {
  id String @id @default(cuid())

  // Formation parent
  formationId String
  formation   Formation @relation(fields: [formationId], references: [id], onDelete: Cascade)

  // Étape 3 - Modalité et lieu
  modalite SessionModalite @default(PRESENTIEL)

  // Si présentiel
  lieuId         String?
  lieu           LieuFormation? @relation(fields: [lieuId], references: [id], onDelete: SetNull)
  lieuTexteLibre String? // Si lieu non enregistré

  // Si distanciel
  lienConnexion   String?
  plateformeVisio String? // Zoom, Google Meet, Teams, etc.

  // Étape 4 - Formateur principal
  formateurId String?
  formateur   Intervenant? @relation("SessionFormateur", fields: [formateurId], references: [id], onDelete: SetNull)

  // Notes internes
  notes String? @db.Text

  // Statut
  status String @default("brouillon") // brouillon, en_cours, termine

  // Multi-tenant
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  clients            SessionClient[]
  journees           SessionJournee[]
  coFormateurs       SessionCoFormateur[]
  documentsGeneres   SessionDocument[]
  signatureDocuments SignatureDocument[]

  // Évaluations de satisfaction (Qualiopi IND 2)
  evaluationsSatisfaction EvaluationSatisfaction[]
  evaluationsIntervenant  EvaluationIntervenant[]

  @@index([formationId])
  @@index([organizationId])
  @@index([status])
}

// Journées de formation (Étape 3)
model SessionJournee {
  id String @id @default(cuid())

  // Session parent
  sessionId String
  session   DocumentSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Ordre
  ordre Int @default(1)

  // Date
  date DateTime

  // Horaires
  heureDebutMatin String? // "09:00"
  heureFinMatin   String? // "12:30"
  heureDebutAprem String? // "14:00"
  heureFinAprem   String? // "17:30"

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  feuillesEmargement FeuilleEmargement[]

  @@index([sessionId])
  @@index([date])
}

// Co-formateurs (Étape 4)
model SessionCoFormateur {
  id String @id @default(cuid())

  // Session parent
  sessionId String
  session   DocumentSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Intervenant
  intervenantId String
  intervenant   Intervenant @relation(fields: [intervenantId], references: [id], onDelete: Cascade)

  // Metadata
  createdAt DateTime @default(now())

  @@unique([sessionId, intervenantId])
  @@index([sessionId])
}

// Clients de la session (Étape 1)
model SessionClient {
  id String @id @default(cuid())

  // Session parent
  sessionId String
  session   DocumentSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Type de client
  typeClient ApprenantStatus // ENTREPRISE (mapped to SALARIE), INDEPENDANT, PARTICULIER

  // Si entreprise
  entrepriseId String?
  entreprise   Entreprise? @relation(fields: [entrepriseId], references: [id], onDelete: SetNull)

  // Étape 2 - Tarifs
  tarifHT  Float? // Tarif appliqué
  tarifTTC Float?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  participants SessionParticipant[]
  financements SessionClientFinancement[]

  @@index([sessionId])
  @@index([entrepriseId])
}

// Financement d'un client (Étape 2)
model SessionClientFinancement {
  id String @id @default(cuid())

  // Client parent
  clientId String
  client   SessionClient @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Financeur
  financeurId String
  financeur   Financeur @relation(fields: [financeurId], references: [id], onDelete: Cascade)

  // Montants
  montantFinanceHT  Float  @default(0)
  montantFinanceTTC Float?

  // Notes
  notes String?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([clientId, financeurId])
  @@index([clientId])
  @@index([financeurId])
}

// Participants à la session (liés à un client)
model SessionParticipant {
  id String @id @default(cuid())

  // Client parent
  clientId String
  client   SessionClient @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Apprenant
  apprenantId String
  apprenant   Apprenant @relation(fields: [apprenantId], references: [id], onDelete: Cascade)

  // Statut de participation
  estConfirme Boolean @default(false)
  aAssiste    Boolean @default(false)

  // Qualiopi IND 3 - Suivi certification (si formation certifiante)
  certificationObtenue Boolean   @default(false)
  dateCertification    DateTime?
  numeroCertificat     String?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  signatures SignatureEmargement[]

  @@unique([clientId, apprenantId])
  @@index([clientId])
  @@index([apprenantId])
}

// Documents générés pour la session (Étape 5)
model SessionDocument {
  id String @id @default(cuid())

  // Session parent
  sessionId String
  session   DocumentSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Type de document
  type DocumentType

  // Pour qui (optionnel)
  clientId    String? // Si document par client (convention)
  apprenantId String? // Si document par apprenant (convocation, attestation)

  // Contenu généré
  content  Json?
  fileUrl  String?
  fileName String?

  // Statut
  status String @default("pending") // pending, generated, sent

  // Metadata
  generatedAt DateTime?
  sentAt      DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([sessionId])
  @@index([type])
  @@index([status])
}

// ===========================================
// ÉMARGEMENT - Feuilles de présence QR Code
// ===========================================

// Feuille d'émargement pour une journée de session
model FeuilleEmargement {
  id String @id @default(cuid())

  // Journée de session parent
  journeeId String
  journee   SessionJournee @relation(fields: [journeeId], references: [id], onDelete: Cascade)

  // Token unique pour le QR code (sécurité)
  token String @unique @default(cuid())

  // QR Code expiré ?
  expiresAt DateTime?

  // Statut
  status String @default("active") // active, closed, expired

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  signatures SignatureEmargement[]

  @@index([journeeId])
  @@index([token])
  @@index([status])
}

// Signature d'un participant OU formateur sur une feuille
model SignatureEmargement {
  id String @id @default(cuid())

  // Feuille parent
  feuilleId String
  feuille   FeuilleEmargement @relation(fields: [feuilleId], references: [id], onDelete: Cascade)

  // Type de signataire
  signataire String @default("participant") // "participant" ou "formateur"

  // Participant (si signataire = participant)
  participantId String?
  participant   SessionParticipant? @relation(fields: [participantId], references: [id], onDelete: Cascade)

  // Formateur/Intervenant (si signataire = formateur)
  intervenantId String?
  intervenant   Intervenant? @relation(fields: [intervenantId], references: [id], onDelete: SetNull)

  // Période (matin ou après-midi)
  periode String // "matin", "apres_midi"

  // Signature (base64 ou URL si stockée)
  signatureData String? @db.Text // Signature manuscrite en base64

  // Horodatage précis de la signature
  signedAt DateTime @default(now())

  // IP et User-Agent pour traçabilité
  ipAddress String?
  userAgent String?

  // Géolocalisation (optionnel)
  latitude  Float?
  longitude Float?

  // Metadata
  createdAt DateTime @default(now())

  @@unique([feuilleId, participantId, periode])
  @@unique([feuilleId, intervenantId, periode])
  @@index([feuilleId])
  @@index([participantId])
  @@index([intervenantId])
  @@index([signedAt])
}

// ===========================================
// CRM - Pipeline de vente
// ===========================================

enum CRMStage {
  ENTRANT // Nouveau prospect entrant
  DISCUSSION // En discussion avec le prospect
  DEVIS // Devis envoyé
  CONVENTION // Convention en cours
  FACTURE // Facturé
  GAGNE // Affaire gagnée
  PERDU // Affaire perdue
}

enum CRMSource {
  SITE_WEB
  BOUCHE_A_OREILLE
  RESEAUX_SOCIAUX
  SALON_EVENEMENT
  PARTENAIRE
  DEMARCHAGE
  AUTRE
}

// Opportunité commerciale (Lead/Deal)
model CRMOpportunite {
  id String @id @default(cuid())

  // Infos de base
  titre       String // Ex: "Formation Excel - Société ABC"
  description String? @db.Text

  // Étape du pipeline
  stage CRMStage @default(ENTRANT)
  ordre Int      @default(0) // Ordre dans la colonne

  // Valeur et probabilité
  montantHT   Float?
  probabilite Int    @default(50) // 0-100%

  // Source
  source CRMSource @default(AUTRE)

  // Contact principal
  contactNom       String?
  contactEmail     String?
  contactTelephone String?
  contactFonction  String?

  // Entreprise liée (optionnel)
  entrepriseId String?
  entreprise   Entreprise? @relation(fields: [entrepriseId], references: [id], onDelete: SetNull)

  // Formation liée (optionnel)
  formationId String?
  formation   Formation? @relation(fields: [formationId], references: [id], onDelete: SetNull)

  // Dates importantes
  dateRelance      DateTime? // Prochaine relance prévue
  dateCloturePrevu DateTime? // Date de clôture prévue

  // Notes et activité
  notes          String?   @db.Text
  dernierContact DateTime?

  // Raison de perte (si stage = PERDU)
  raisonPerte String?

  // Multi-tenant
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Créateur
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  activites CRMActivite[]

  @@index([organizationId])
  @@index([userId])
  @@index([stage])
  @@index([entrepriseId])
  @@index([dateRelance])
}

// Activités liées à une opportunité
model CRMActivite {
  id String @id @default(cuid())

  // Opportunité parent
  opportuniteId String
  opportunite   CRMOpportunite @relation(fields: [opportuniteId], references: [id], onDelete: Cascade)

  // Type d'activité
  type String // appel, email, reunion, note, relance

  // Contenu
  titre       String
  description String? @db.Text

  // Date de l'activité
  date DateTime @default(now())

  // Fait ou à faire
  estFait Boolean @default(true)

  // Metadata
  createdAt DateTime @default(now())

  @@index([opportuniteId])
  @@index([date])
}

// ===========================================
// LMS - Suivi de progression des apprenants
// ===========================================

enum LMSStatut {
  NON_COMMENCE
  EN_COURS
  COMPLETE
}

// Inscription d'un apprenant à une formation (parcours LMS)
model LMSInscription {
  id String @id @default(cuid())

  // Formation
  formationId String
  formation   Formation @relation(fields: [formationId], references: [id], onDelete: Cascade)

  // Apprenant
  apprenantId String
  apprenant   Apprenant @relation(fields: [apprenantId], references: [id], onDelete: Cascade)

  // Progression globale
  progression Int       @default(0) // 0-100%
  statut      LMSStatut @default(NON_COMMENCE)

  // Dates
  dateInscription DateTime  @default(now())
  dateDebut       DateTime? // Première activité
  dateFin         DateTime? // Complétion

  // Temps passé (en minutes)
  tempsTotal Int @default(0)

  // Notes/Résultats
  noteFinale       Float? // Note moyenne ou finale
  certificatGenere Boolean @default(false)

  // Multi-tenant
  organizationId String

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  progressionModules LMSProgressionModule[]
  scormTrackings     SCORMTracking[]

  @@unique([formationId, apprenantId])
  @@index([formationId])
  @@index([apprenantId])
  @@index([organizationId])
  @@index([statut])
}

// Progression par module
model LMSProgressionModule {
  id String @id @default(cuid())

  // Inscription parent
  inscriptionId String
  inscription   LMSInscription @relation(fields: [inscriptionId], references: [id], onDelete: Cascade)

  // Module
  moduleId String
  module   Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  // Progression
  progression Int       @default(0) // 0-100%
  statut      LMSStatut @default(NON_COMMENCE)

  // Temps passé (en minutes)
  tempsPasse Int @default(0)

  // Dates
  dateDebut DateTime?
  dateFin   DateTime?

  // Évaluations
  scoreQuiz      Float?
  tentativesQuiz Int    @default(0)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([inscriptionId, moduleId])
  @@index([inscriptionId])
  @@index([moduleId])
}

// ===========================================
// CLASSE VIRTUELLE - Visioconférence intégrée
// ===========================================

enum VirtualRoomStatus {
  SCHEDULED // Programmée
  ACTIVE // En cours
  ENDED // Terminée
}

// Salle de classe virtuelle
model VirtualRoom {
  id String @id @default(cuid())

  // Infos de base
  titre       String // Ex: "Session Module 1 - Excel Avancé"
  description String?

  // Session liée (optionnel)
  sessionId String?

  // Formateur hôte
  hosteNom   String?
  hosteEmail String?

  // Configuration de la salle
  roomId   String  @unique @default(cuid()) // ID unique pour MiroTalk
  password String? // Mot de passe optionnel

  // Dates
  dateDebut    DateTime
  dateFin      DateTime?
  dureeMinutes Int       @default(60)

  // Statut
  status VirtualRoomStatus @default(SCHEDULED)

  // Configuration MiroTalk
  maxParticipants   Int     @default(50)
  enregistrement    Boolean @default(false)
  chatActif         Boolean @default(true)
  ecranPartageActif Boolean @default(true)

  // Statistiques post-session
  nombreParticipants Int?
  dureeTotale        Int? // Minutes effectives

  // Multi-tenant
  organizationId String

  // Créateur
  userId String

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([userId])
  @@index([roomId])
  @@index([status])
  @@index([dateDebut])
}

// ===========================================
// SIGNATURE ÉLECTRONIQUE SÉCURISÉE
// ===========================================

enum SignatureDocumentStatus {
  DRAFT // Brouillon, pas encore envoyé
  PENDING_SIGNATURE // En attente de signature
  SIGNED // Signé
  EXPIRED // Expiré (délai dépassé)
  CANCELLED // Annulé
}

enum SignatureAuthMethod {
  EMAIL_ONLY // Simple validation email
  EMAIL_SMS // Double auth : email + SMS
  EMAIL_CODE // Email + code à 6 chiffres
}

// Document à faire signer
model SignatureDocument {
  id String @id @default(cuid())

  // Lien vers le document source (template rendu)
  titre             String // Ex: "Convention de formation - Jean Dupont"
  documentType      DocumentType // Type de document
  contenuHtml       String       @db.Text // Contenu HTML du document
  signedContenuHtml String?      @db.Text // Contenu HTML avec signature intégrée (après signature)

  // Destinataire
  destinataireNom   String
  destinataireEmail String
  destinataireTel   String? // Pour double auth SMS

  // Lien optionnel vers apprenant ou entreprise
  apprenantId  String?
  apprenant    Apprenant?  @relation(fields: [apprenantId], references: [id], onDelete: SetNull)
  entrepriseId String?
  entreprise   Entreprise? @relation(fields: [entrepriseId], references: [id], onDelete: SetNull)

  // Session de formation liée (optionnel)
  sessionId String?
  session   DocumentSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  // Configuration de signature
  authMethod SignatureAuthMethod     @default(EMAIL_SMS)
  expiresAt  DateTime? // Date d'expiration
  status     SignatureDocumentStatus @default(DRAFT)

  // Token unique pour accès signature (lien sécurisé)
  token String @unique @default(cuid())

  // Envoi
  sentAt DateTime? // Date d'envoi
  sentBy String? // ID de l'utilisateur qui a envoyé

  // Relances
  lastReminderAt DateTime?
  reminderCount  Int       @default(0)

  // Multi-tenant
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  signatures        SignatureRecord[]
  verificationCodes SignatureVerificationCode[]

  @@index([organizationId])
  @@index([token])
  @@index([status])
  @@index([apprenantId])
  @@index([entrepriseId])
  @@index([sessionId])
  @@index([destinataireEmail])
}

// Code de vérification pour double authentification
model SignatureVerificationCode {
  id String @id @default(cuid())

  documentId String
  document   SignatureDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  // Code
  code      String // Code à 6 chiffres
  method    String // "sms" ou "email"
  expiresAt DateTime // Expiration (5 min)
  usedAt    DateTime? // Date d'utilisation

  // Tentatives
  attempts Int @default(0)

  // Metadata
  createdAt DateTime @default(now())

  @@index([documentId])
  @@index([code])
}

// Enregistrement de signature (preuve légale)
model SignatureRecord {
  id String @id @default(cuid())

  documentId String
  document   SignatureDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  // Identification du signataire
  signataireName  String
  signataireEmail String

  // Signature manuscrite
  signatureData String @db.Text // Image base64 de la signature

  // Authentification effectuée
  authMethod SignatureAuthMethod

  // Horodatage certifié
  signedAt DateTime @default(now())

  // Preuve d'intégrité
  documentHash  String // Hash SHA-256 du document au moment de la signature
  signatureHash String // Hash de la signature

  // Métadonnées de traçabilité
  ipAddress   String?
  userAgent   String?
  geoLocation String? // Localisation approximative (pays, ville)

  // Consentement explicite
  consentText     String  @default("Je certifie avoir lu et approuvé ce document")
  consentAccepted Boolean @default(true)

  // Certificat de signature (PDF généré)
  certificateUrl String? // URL du certificat stocké

  // Metadata
  createdAt DateTime @default(now())

  @@unique([documentId]) // Un seul enregistrement par document
  @@index([signataireEmail])
  @@index([signedAt])
}

// ===========================================
// SCORM - Learning Management System
// ===========================================

enum SCORMVersion {
  SCORM_1_2 // Version 1.2 (la plus répandue)
  SCORM_2004 // Version 2004
}

enum SCORMPackageStatus {
  UPLOADING // En cours d'upload
  PROCESSING // En cours de traitement
  VALID // Valide et prêt à l'emploi
  ERROR // Erreur lors du traitement
  ARCHIVED // Archivé
}

enum SCORMLessonStatus {
  NOT_ATTEMPTED // Pas commencé
  INCOMPLETE // En cours
  COMPLETED // Terminé
  PASSED // Réussi
  FAILED // Échoué
  BROWSED // Consulté
}

// Package SCORM importé
model SCORMPackage {
  id String @id @default(cuid())

  // Infos du package
  titre       String // Nom du module SCORM
  description String? // Description
  version     SCORMVersion @default(SCORM_1_2)

  // Statut
  status       SCORMPackageStatus @default(UPLOADING)
  errorMessage String? // Message d'erreur si status=ERROR

  // Manifest info (parsé depuis imsmanifest.xml)
  manifestData Json? // Données complètes du manifest
  launchUrl    String? // URL de lancement (ex: "index.html")
  masteryScore Float? // Score minimum pour réussite (0-100)

  // Stockage
  storagePath      String // Chemin dans Supabase Storage
  originalFileName String // Nom du fichier original
  fileSize         Int // Taille en bytes

  // Lien optionnel avec formation/module
  formationId String?
  formation   Formation? @relation(fields: [formationId], references: [id], onDelete: SetNull)

  moduleId String?

  // Multi-tenant
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Créateur
  uploadedBy String // User ID

  // Compteurs
  usageCount Int @default(0) // Nombre de fois utilisé dans des sessions

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  trackingData SCORMTracking[]

  @@index([organizationId])
  @@index([formationId])
  @@index([status])
}

// Données de suivi SCORM par apprenant
model SCORMTracking {
  id String @id @default(cuid())

  // Package SCORM
  packageId String
  package   SCORMPackage @relation(fields: [packageId], references: [id], onDelete: Cascade)

  // Apprenant
  apprenantId String
  apprenant   Apprenant @relation(fields: [apprenantId], references: [id], onDelete: Cascade)

  // Inscription LMS liée (optionnel)
  inscriptionId String?
  inscription   LMSInscription? @relation(fields: [inscriptionId], references: [id], onDelete: SetNull)

  // Données CMI complètes (JSON pour flexibilité)
  cmiData Json @default("{}")

  // Champs clés extraits pour requêtes rapides
  lessonStatus     SCORMLessonStatus @default(NOT_ATTEMPTED)
  completionStatus String? // SCORM 2004: completed, incomplete, not attempted, unknown
  successStatus    String? // SCORM 2004: passed, failed, unknown

  // Score
  scoreRaw    Float? // Score brut
  scoreMin    Float? // Score minimum possible
  scoreMax    Float? // Score maximum possible
  scoreScaled Float? // Score normalisé (-1 à 1 pour SCORM 2004)

  // Temps
  totalTime   String? // Format ISO 8601 ou SCORM
  sessionTime String? // Temps de la session actuelle

  // Bookmark/Suspend
  suspendData    String? @db.Text // Données de reprise (max 64KB SCORM 2004)
  lessonLocation String? // Bookmark de position
  entry          String? // "ab-initio", "resume", ""
  exit           String? // "time-out", "suspend", "logout", ""

  // Tentatives
  attemptNumber Int @default(1)

  // Interactions (pour analyse détaillée)
  interactions Json? // Array des interactions SCORM

  // Objectifs (SCORM 2004)
  objectives Json? // Array des objectifs

  // Timestamps
  firstAccessAt DateTime  @default(now())
  lastAccessAt  DateTime  @default(now())
  completedAt   DateTime?

  // Multi-tenant
  organizationId String

  @@unique([packageId, apprenantId, attemptNumber])
  @@index([packageId])
  @@index([apprenantId])
  @@index([inscriptionId])
  @@index([organizationId])
  @@index([lessonStatus])
}

// ===========================================
// NOUVEAU SYSTÈME DE SESSIONS
// ===========================================

// Session de formation (instance d'une formation)
model Session {
  id String @id @default(cuid())

  // Référence unique lisible (ex: "NEURO-2025-001")
  reference String  @unique
  nom       String? // Nom personnalisé optionnel (ex: "Session Janvier - Entreprise ABC")

  // Formation parent (base pédagogique)
  formationId String
  formation   Formation @relation(fields: [formationId], references: [id], onDelete: Cascade)

  // Statut de la session
  status SessionStatus @default(BROUILLON)

  // Modalité et lieu
  modalite SessionModalite @default(PRESENTIEL)

  // Si présentiel
  lieuId         String?
  lieu           LieuFormation? @relation("SessionLieu", fields: [lieuId], references: [id], onDelete: SetNull)
  lieuTexteLibre String? // Si lieu non enregistré

  // Si distanciel
  lienConnexion   String?
  plateformeVisio String? // Zoom, Google Meet, Teams, etc.

  // Formateur principal
  formateurId String?
  formateur   Intervenant? @relation("SessionFormateurPrincipal", fields: [formateurId], references: [id], onDelete: SetNull)

  // Tarification globale de la session (optionnel)
  tarifParDefautHT Float? // Tarif par défaut HT
  tauxTVA          Float  @default(20) // Taux de TVA en %

  // Notes internes
  notes String? @db.Text

  // Qualiopi IND 3 - Certification par session
  // Si true, cette session délivre des certifications
  // Si false, pas de certification pour cette session (même si formation certifiante)
  // Par défaut null = hérite du paramètre isCertifiante de la formation
  delivreCertification Boolean?

  // Multi-tenant
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  journees         SessionJourneeNew[] // Journées de formation
  clients          SessionClientNew[] // Clients de la session
  coFormateurs     SessionCoFormateurNew[] // Co-formateurs
  documentsGeneres SessionDocumentNew[] // Documents générés
  signatures       SignatureDocumentNew[] // Documents de signature
  fichesMission    FicheMissionIntervenant[] @relation("FicheMissionSession") // Fiches mission (Qualiopi IND 17)
  reclamations     Reclamation[]

  @@index([formationId])
  @@index([organizationId])
  @@index([status])
  @@index([reference])
}

// Journées de formation (NEW)
model SessionJourneeNew {
  id String @id @default(cuid())

  // Session parent
  sessionId String
  session   Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Ordre
  ordre Int @default(1)

  // Date
  date DateTime

  // Horaires
  heureDebutMatin String? // "09:00"
  heureFinMatin   String? // "12:30"
  heureDebutAprem String? // "14:00"
  heureFinAprem   String? // "17:30"

  // Lieu spécifique (si différent de la session)
  lieuSpecifique String?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  feuillesEmargement FeuilleEmargementNew[]

  @@index([sessionId])
  @@index([date])
}

// Clients de la session (NEW)
model SessionClientNew {
  id String @id @default(cuid())

  // Session parent
  sessionId String
  session   Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Type de client
  typeClient ApprenantStatus // SALARIE (entreprise), INDEPENDANT, PARTICULIER

  // Si entreprise
  entrepriseId String?
  entreprise   Entreprise? @relation("SessionClientEntreprise", fields: [entrepriseId], references: [id], onDelete: SetNull)

  // Si indépendant/particulier (contact direct)
  contactNom       String?
  contactPrenom    String?
  contactEmail     String?
  contactTelephone String?

  // Tarifs appliqués
  tarifHT  Float?
  tarifTTC Float?
  tauxTVA  Float  @default(20)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  participants SessionParticipantNew[]
  financements SessionFinancementNew[]

  @@index([sessionId])
  @@index([entrepriseId])
}

// Financement d'un client (NEW)
model SessionFinancementNew {
  id String @id @default(cuid())

  // Client parent
  clientId String
  client   SessionClientNew @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Financeur
  financeurId String
  financeur   Financeur @relation("SessionFinanceur", fields: [financeurId], references: [id], onDelete: Cascade)

  // Montants
  montantFinanceHT  Float  @default(0)
  montantFinanceTTC Float?

  // Référence dossier
  referenceDossier String?

  // Notes
  notes String?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([clientId, financeurId])
  @@index([clientId])
  @@index([financeurId])
}

// Participants à la session (NEW)
model SessionParticipantNew {
  id String @id @default(cuid())

  // Client parent
  clientId String
  client   SessionClientNew @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Apprenant
  apprenantId String
  apprenant   Apprenant @relation("SessionParticipantApprenant", fields: [apprenantId], references: [id], onDelete: Cascade)

  // Statut de participation
  estConfirme      Boolean   @default(false)
  aAssiste         Boolean   @default(false)
  dateConfirmation DateTime?

  // Qualiopi IND 3 - Suivi certification (si formation certifiante)
  certificationObtenue Boolean   @default(false)
  dateCertification    DateTime?
  numeroCertificat     String?

  // Notes sur le participant
  notes String?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  signatures SignatureEmargementNew[]

  @@unique([clientId, apprenantId])
  @@index([clientId])
  @@index([apprenantId])
}

// Co-formateurs de la session (NEW)
model SessionCoFormateurNew {
  id String @id @default(cuid())

  // Session parent
  sessionId String
  session   Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Intervenant
  intervenantId String
  intervenant   Intervenant @relation("SessionCoFormateurIntervenant", fields: [intervenantId], references: [id], onDelete: Cascade)

  // Rôle/Spécialité
  role String? // Ex: "Expert technique", "Coach"

  // Metadata
  createdAt DateTime @default(now())

  @@unique([sessionId, intervenantId])
  @@index([sessionId])
}

// Documents générés pour la session (NEW)
model SessionDocumentNew {
  id String @id @default(cuid())

  // Session parent
  sessionId String
  session   Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Type de document
  type DocumentType

  // Pour qui (optionnel)
  clientId      String? // Si document pour un client spécifique
  participantId String? // Si document pour un participant spécifique

  // Contenu
  titre   String
  content Json? // Contenu TipTap JSON
  fileUrl String? // URL du fichier généré (PDF)

  // Statut
  isGenerated Boolean   @default(false)
  generatedAt DateTime?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sessionId])
  @@index([type])
}

// Feuilles d'émargement (NEW)
model FeuilleEmargementNew {
  id String @id @default(cuid())

  // Journée parent
  journeeId String
  journee   SessionJourneeNew @relation(fields: [journeeId], references: [id], onDelete: Cascade)

  // Token unique pour QR code / lien
  token String @unique @default(cuid())

  // Statut
  isActive  Boolean   @default(true)
  expiresAt DateTime?

  // PDF généré
  pdfUrl         String?
  pdfGeneratedAt DateTime?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  signatures SignatureEmargementNew[]

  @@index([journeeId])
  @@index([token])
}

// Signatures d'émargement (NEW)
model SignatureEmargementNew {
  id String @id @default(cuid())

  // Feuille d'émargement
  feuilleId String
  feuille   FeuilleEmargementNew @relation(fields: [feuilleId], references: [id], onDelete: Cascade)

  // Participant (si apprenant)
  participantId String?
  participant   SessionParticipantNew? @relation(fields: [participantId], references: [id], onDelete: Cascade)

  // Formateur (si formateur)
  formateurId String?
  formateur   Intervenant? @relation("SignatureEmargementFormateur", fields: [formateurId], references: [id], onDelete: SetNull)

  // Type de signataire
  typeSignataire String // "apprenant" ou "formateur"

  // Période
  periode String // "matin" ou "aprem"

  // Signature
  signatureData String?  @db.Text // Image base64 de la signature
  signedAt      DateTime @default(now())

  // Localisation (optionnel)
  latitude  Float?
  longitude Float?
  ipAddress String?

  // Metadata
  createdAt DateTime @default(now())

  @@unique([feuilleId, participantId, periode])
  @@unique([feuilleId, formateurId, periode])
  @@index([feuilleId])
  @@index([participantId])
  @@index([formateurId])
}

// Documents de signature électronique (NEW)
model SignatureDocumentNew {
  id String @id @default(cuid())

  // Session parent
  sessionId String
  session   Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Document à signer
  documentId   String? // Référence au SessionDocumentNew
  documentType DocumentType // Type de document (CONVENTION, CONTRAT, etc.)
  titre        String

  // Fichier
  fileUrl String // URL du document PDF à signer

  // Signataires
  signataires Json // Array de {email, nom, role, status, signedAt}

  // Statut global
  status      String    @default("draft") // draft, pending, partial, completed, cancelled
  completedAt DateTime?

  // Intégration signature électronique (Yousign, DocuSign, etc.)
  externalId       String? // ID chez le provider de signature
  externalProvider String? // "yousign", "docusign", "internal"

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sessionId])
  @@index([status])
}

// ===========================================
// QUALIOPI - INDICATEUR 1 : CATALOGUE PUBLIC & PRÉ-INSCRIPTION
// ===========================================

enum SituationProfessionnelle {
  SALARIE
  INDEPENDANT
  PARTICULIER
  DEMANDEUR_EMPLOI
  ETUDIANT
  RETRAITE
  AUTRE
}

enum ModeFinancement {
  ENTREPRISE
  OPCO
  CPF
  FRANCE_TRAVAIL
  PERSONNEL
  MIXTE
  AUTRE
}

enum PreInscriptionStatut {
  NOUVELLE
  EN_TRAITEMENT
  ACCEPTEE
  REFUSEE
  ANNULEE
}

// Pré-inscription depuis le catalogue public
model PreInscription {
  id String @id @default(cuid())

  // Organisation cible
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Formation demandée
  formationId String
  formation   Formation @relation(fields: [formationId], references: [id], onDelete: Cascade)

  // ===========================================
  // PARTIE 1 : ANALYSE DU BESOIN (Qualiopi IND 1 & 4)
  // ===========================================
  objectifsProfessionnels String? @db.Text // Objectifs professionnels recherchés
  contexte                String? @db.Text // Contexte de la demande
  experiencePrealable     String? @db.Text // Expérience préalable dans le domaine
  attentesSpecifiques     String? @db.Text // Attentes spécifiques
  contraintes             String? @db.Text // Contraintes (horaires, lieu, etc.)

  // ===========================================
  // PARTIE 2 : FICHE DE RENSEIGNEMENTS
  // ===========================================
  // Identité
  civilite      String? // M., Mme
  nom           String
  prenom        String
  dateNaissance DateTime?
  lieuNaissance String?

  // Coordonnées
  email      String
  telephone  String?
  adresse    String?
  codePostal String?
  ville      String?
  pays       String  @default("France")

  // Situation professionnelle
  situationProfessionnelle SituationProfessionnelle?
  entreprise               String? // Nom de l'entreprise (si salarié)
  poste                    String? // Poste actuel
  siret                    String? // SIRET (si indépendant)

  // ===========================================
  // HANDICAP (OBLIGATOIRE QUALIOPI)
  // ===========================================
  situationHandicap   Boolean @default(false)
  besoinsAmenagements String? @db.Text // Aménagements spécifiques nécessaires

  // ===========================================
  // FINANCEMENT
  // ===========================================
  modeFinancement        ModeFinancement?
  financeurNom           String? // Nom du financeur si OPCO ou autre
  commentaireFinancement String?          @db.Text

  // ===========================================
  // GESTION
  // ===========================================
  statut      PreInscriptionStatut @default(NOUVELLE)
  noteInterne String?              @db.Text // Notes internes de l'OF
  motifRefus  String?              @db.Text // Motif si refus

  // Conversion en apprenant
  apprenantId String? // Si converti en apprenant
  apprenant   Apprenant? @relation(fields: [apprenantId], references: [id], onDelete: SetNull)

  // Metadata
  sourceUrl String? // URL source de la pré-inscription
  ipAddress String? // IP pour traçabilité
  userAgent String? // User agent

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  traiteeAt  DateTime? // Date de traitement
  traiteePar String? // User ID qui a traité

  @@index([organizationId])
  @@index([formationId])
  @@index([statut])
  @@index([email])
  @@index([createdAt])
}

// ===========================================
// QUALIOPI - INDICATEUR 2 : INDICATEURS DE RÉSULTATS
// ===========================================

model FormationIndicateurs {
  id String @id @default(cuid())

  // Formation
  formationId String    @unique
  formation   Formation @relation(fields: [formationId], references: [id], onDelete: Cascade)

  // Indicateurs calculés
  tauxSatisfaction  Float? // Taux de satisfaction (%) depuis éval à chaud
  nombreAvis        Int    @default(0)
  nombreStagiaires  Int    @default(0)
  tauxReussite      Float? // Taux de réussite évaluation finale (%)
  tauxCertification Float? // Taux d'obtention certification (si certifiante)
  tauxAbandon       Float? // Taux d'abandon (%)

  // Période de calcul
  annee         Int? // Année de référence (N-1)
  dernierCalcul DateTime?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([formationId])
}

// ===========================================
// ÉVALUATIONS (Persistées)
// ===========================================

model Evaluation {
  id String @id @default(cuid())

  // Formation parent
  formationId String
  formation   Formation @relation(fields: [formationId], references: [id], onDelete: Cascade)

  // Type d'évaluation
  type EvaluationType

  // Module associé (si QCM_MODULE ou ATELIER_MODULE)
  moduleId String?

  // Contenu
  titre        String
  description  String? @db.Text
  dureeEstimee Int? // Durée estimée en minutes

  // Questions/Contenu (JSON pour flexibilité)
  // Pour QCM: Array de {question, options[], correctAnswer, explication?}
  // Pour Atelier: {consignes, objectifs[], materiel[], livrables[]}
  contenu Json

  // Paramètres
  scoreMinimum      Float? // Score minimum pour validation (%)
  nombreQuestions   Int? // Nombre de questions à afficher (si random)
  tempsLimite       Int? // Temps limite en minutes (optionnel)
  melangerQuestions Boolean @default(false)
  melangerReponses  Boolean @default(false)

  // Ordre d'affichage
  ordre Int @default(0)

  // Metadata
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  resultats EvaluationResultat[]

  @@index([formationId])
  @@index([type])
  @@index([moduleId])
}

// Résultats d'évaluation par apprenant
model EvaluationResultat {
  id String @id @default(cuid())

  // Évaluation
  evaluationId String
  evaluation   Evaluation @relation(fields: [evaluationId], references: [id], onDelete: Cascade)

  // Apprenant
  apprenantId String
  apprenant   Apprenant @relation("EvaluationResultatApprenant", fields: [apprenantId], references: [id], onDelete: Cascade)

  // Session (contexte de passage)
  sessionId String?

  // Résultats
  score       Float? // Score obtenu (%)
  reponses    Json? // Détail des réponses
  tempsPassé Int? // Temps passé en secondes

  // Statut
  status      String    @default("en_cours") // en_cours, termine, valide, echoue
  startedAt   DateTime  @default(now())
  completedAt DateTime?

  // Tentative
  tentative Int @default(1)

  // Feedback formateur (optionnel)
  feedbackFormateur String? @db.Text
  noteFormateur     Float? // Note manuelle du formateur

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([evaluationId, apprenantId, tentative])
  @@index([evaluationId])
  @@index([apprenantId])
  @@index([sessionId])
}

// ===========================================
// EMAILS ENVOYÉS (Traçabilité Qualiopi)
// ===========================================
// Stockage permanent de tous les emails envoyés pour audit Qualiopi

enum SentEmailType {
  VERIFICATION_CODE // Code de vérification (signature, etc.)
  SIGNATURE_INVITATION // Invitation à signer un document
  INVITATION_APPRENANT // Invitation espace apprenant
  PRE_INSCRIPTION // Confirmation pré-inscription
  NOTIFICATION_ADMIN // Notification aux administrateurs
  CONVOCATION // Convocation à une session
  ATTESTATION // Envoi d'attestation
  CONVENTION // Envoi de convention
  DOCUMENT // Envoi de document générique
  RAPPEL // Rappel (session, signature, etc.)
  ADAPTATION_PARCOURS // Qualiopi IND 10 - Fiche d'adaptabilité du parcours
  OTHER // Autre type d'email
}

enum SentEmailStatus {
  SENT // Envoyé avec succès
  DELIVERED // Délivré (si webhook Resend configuré)
  OPENED // Ouvert (si tracking activé)
  CLICKED // Lien cliqué
  BOUNCED // Rebond (adresse invalide)
  FAILED // Échec d'envoi
}

model SentEmail {
  id String @id @default(cuid())

  // Organisation (multi-tenant)
  organizationId String

  // Destinataire(s)
  toEmail   String // Email principal du destinataire
  toName    String? // Nom du destinataire
  ccEmails  String[] // Emails en copie
  bccEmails String[] // Emails en copie cachée

  // Contenu
  subject     String // Sujet de l'email
  htmlContent String  @db.Text // Contenu HTML complet
  textContent String? @db.Text // Contenu texte (optionnel)

  // Type et statut
  type   SentEmailType   @default(OTHER)
  status SentEmailStatus @default(SENT)

  // Métadonnées de tracking (Resend)
  resendId    String? // ID Resend pour suivi
  deliveredAt DateTime? // Date de délivrance
  openedAt    DateTime? // Date d'ouverture
  clickedAt   DateTime? // Date du premier clic

  // Références vers les entités liées (optionnel)
  apprenantId         String? // Si lié à un apprenant
  sessionId           String? // Si lié à une session
  formationId         String? // Si lié à une formation
  preInscriptionId    String? // Si lié à une pré-inscription
  signatureDocumentId String? // Si lié à un document de signature

  // Pièces jointes (stockées comme JSON)
  attachments Json? // [{filename, size, contentType}]

  // Expéditeur (pour audit)
  sentByUserId String? // User qui a déclenché l'envoi (si applicable)
  sentBySystem Boolean @default(false) // true si envoi automatique

  // Metadata technique
  ipAddress String? // IP de l'utilisateur qui a déclenché
  userAgent String? // User agent

  // Erreur (si FAILED ou BOUNCED)
  errorMessage String?

  // Timestamps
  sentAt    DateTime @default(now())
  createdAt DateTime @default(now())

  @@index([organizationId])
  @@index([toEmail])
  @@index([type])
  @@index([status])
  @@index([sentAt])
  @@index([apprenantId])
  @@index([sessionId])
  @@index([formationId])
  @@index([preInscriptionId])
}

// ===========================================
// NOTIFICATIONS
// ===========================================
// Système de notifications internes

enum NotificationType {
  PRE_INSCRIPTION // Nouvelle pré-inscription reçue
  INSCRIPTION // Inscription validée
  SESSION_RAPPEL // Rappel de session à venir
  FORMATION_MODIFIEE // Formation modifiée
  DOCUMENT_GENERE // Document généré
  EVALUATION_COMPLETE // Évaluation complétée par un apprenant
  PAIEMENT_RECU // Paiement reçu
  SYSTEME // Notification système
}

model Notification {
  id String @id @default(cuid())

  // Organisation (multi-tenant)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Destinataire
  userId String? // null = notification pour tous les admins de l'org
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Contenu
  type    NotificationType
  titre   String
  message String           @db.Text

  // Lien vers la ressource concernée
  resourceType String? // "preInscription", "formation", "session", "apprenant", etc.
  resourceId   String?
  actionUrl    String? // URL vers la page concernée

  // Statut
  isRead Boolean   @default(false)
  readAt DateTime?

  // Metadata
  metadata  Json? // Données supplémentaires
  createdAt DateTime @default(now())

  @@index([organizationId])
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

// ===========================================
// AUTHENTIFICATION APPRENANT (Magic Code OTP)
// ===========================================
// Codes de connexion temporaires pour les apprenants

model ApprenantAuthCode {
  id String @id @default(cuid())

  // Apprenant concerné
  apprenantId String
  apprenant   Apprenant @relation(fields: [apprenantId], references: [id], onDelete: Cascade)

  // Code de vérification
  code String // Code à 6 chiffres

  // Validité
  expiresAt DateTime // Expiration (10 minutes)
  usedAt    DateTime? // Date d'utilisation (null si pas encore utilisé)

  // Sécurité
  attempts  Int     @default(0) // Nombre de tentatives
  ipAddress String? // IP de la demande
  userAgent String? // User agent

  // Timestamps
  createdAt DateTime @default(now())

  @@index([apprenantId])
  @@index([code])
  @@index([expiresAt])
}

// Token de première connexion (envoyé dans l'email d'invitation)
model ApprenantInviteToken {
  id String @id @default(cuid())

  // Apprenant concerné
  apprenantId String
  apprenant   Apprenant @relation(fields: [apprenantId], references: [id], onDelete: Cascade)

  // Token unique
  token String @unique

  // Validité
  expiresAt DateTime // Expiration (48h)
  usedAt    DateTime? // Date d'utilisation

  // Timestamps
  createdAt DateTime @default(now())

  @@index([apprenantId])
  @@index([token])
}

// Code OTP pour connexion intervenant
model IntervenantAuthCode {
  id String @id @default(cuid())

  // Intervenant concerné
  intervenantId String
  intervenant   Intervenant @relation(fields: [intervenantId], references: [id], onDelete: Cascade)

  // Code de vérification
  code String // Code à 6 chiffres

  // Validité
  expiresAt DateTime // Expiration (10 minutes)
  usedAt    DateTime? // Date d'utilisation (null si pas encore utilisé)

  // Sécurité
  attempts  Int     @default(0) // Nombre de tentatives
  ipAddress String? // IP de la demande
  userAgent String? // User agent

  // Timestamps
  createdAt DateTime @default(now())

  @@index([intervenantId])
  @@index([code])
  @@index([expiresAt])
}

// ===========================================
// ÉVALUATIONS DE SATISFACTION (Qualiopi IND 2 & 30)
// ===========================================
// Évaluations à chaud (fin de formation) et à froid (3 mois après)
// pour calculer le taux de satisfaction et respecter Qualiopi

enum EvaluationSatisfactionType {
  CHAUD // Évaluation à chaud - fin de formation
  FROID // Évaluation à froid - 3 mois après
}

enum EvaluationSatisfactionStatus {
  PENDING // En attente de complétion
  IN_PROGRESS // En cours de remplissage
  COMPLETED // Complété
  EXPIRED // Expiré
}

// Demande d'évaluation de satisfaction
model EvaluationSatisfaction {
  id String @id @default(cuid())

  // Organisation (multi-tenant)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Session de formation liée
  sessionId String
  session   DocumentSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Apprenant concerné
  apprenantId String
  apprenant   Apprenant @relation("EvaluationSatisfactionApprenant", fields: [apprenantId], references: [id], onDelete: Cascade)

  // Type d'évaluation
  type EvaluationSatisfactionType

  // Token unique pour accès public (QR code / lien)
  token String @unique @default(cuid())

  // Statut
  status EvaluationSatisfactionStatus @default(PENDING)

  // Dates
  expiresAt   DateTime? // Date d'expiration du lien
  sentAt      DateTime? // Date d'envoi au participant
  startedAt   DateTime? // Date de début de complétion
  completedAt DateTime? // Date de complétion

  // Réponse (stockée dans un modèle séparé)
  reponse EvaluationSatisfactionReponse?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sessionId, apprenantId, type])
  @@index([organizationId])
  @@index([sessionId])
  @@index([apprenantId])
  @@index([token])
  @@index([type])
  @@index([status])
}

// Réponses détaillées à l'évaluation de satisfaction
model EvaluationSatisfactionReponse {
  id String @id @default(cuid())

  // Évaluation parent
  evaluationId String                 @unique
  evaluation   EvaluationSatisfaction @relation(fields: [evaluationId], references: [id], onDelete: Cascade)

  // ===========================================
  // SECTION 2: PRÉPARATION (Évaluation à chaud uniquement)
  // ===========================================
  // 2.1 Informations reçues avant la formation
  preparationInfos     Int? // Note 0-10
  // 2.2 Messages envoyés avant la formation
  preparationMessages  Int? // Note 0-10
  // 2.3 Prérequis correspondaient au niveau
  preparationPrerequis Int? // Note 0-10

  // ===========================================
  // SECTION 3: ORGANISATION (Évaluation à chaud uniquement)
  // ===========================================
  // 3.1 Calendrier bien organisé
  organisationCalendrier Int? // Note 0-10
  // 3.2 Conditions matérielles et techniques
  organisationConditions Int? // Note 0-10

  // ===========================================
  // SECTION 4: ANIMATION (Évaluation à chaud uniquement)
  // ===========================================
  // 4.1 Explications claires et structurées
  animationExplications Int? // Note 0-10
  // 4.2 Échanges et participation favorisés
  animationEchanges     Int? // Note 0-10
  // 4.3 Ambiance de travail agréable
  animationAmbiance     Int? // Note 0-10
  // 4.4 Rythme adapté
  animationRythme       Int? // Note 0-10

  // ===========================================
  // SECTION 5: CONTENU (Évaluation à chaud uniquement)
  // ===========================================
  // 5.1 Contenu en cohérence avec attentes
  contenuCoherence Int? // Note 0-10
  // 5.2 Notions utiles pour la pratique
  contenuUtilite   Int? // Note 0-10
  // 5.3 Supports clairs et structurés
  contenuSupports  Int? // Note 0-10
  // 5.4 Niveau adapté au profil
  contenuNiveau    Int? // Note 0-10

  // ===========================================
  // SECTION 6: ATTEINTE DES OBJECTIFS
  // ===========================================
  // Objectifs pédagogiques atteints (0-10)
  objectifsAtteints Int? // Note 0-10

  // ===========================================
  // SECTION 7 (CHAUD) / SECTION 2 (FROID): APPRÉCIATION GLOBALE
  // ===========================================
  // Note globale de satisfaction
  noteGlobale Int? // Note 0-10

  // ===========================================
  // SECTIONS SPÉCIFIQUES À L'ÉVALUATION À FROID
  // ===========================================
  // 2.2 (Froid) Répondu aux attentes initiales
  froidAttentesInitiales Int? // Note 0-10

  // 3.1 (Froid) Compétences utiles acquises
  froidCompetencesUtiles Int? // Note 0-10
  // 3.2 (Froid) Mise en pratique des acquis
  froidMiseEnPratique    Int? // Note 0-10
  // 3.3 (Froid) Impact positif sur le travail
  froidImpactTravail     Int? // Note 0-10

  // 4.1 (Froid) Contenu encore pertinent
  froidPertinenceActuelle Int? // Note 0-10
  // 4.2 (Froid) Utilité dans les prochains mois
  froidUtiliteFuture      Int? // Note 0-10

  // 5 (Froid) Mise en pratique des objectifs pédagogiques
  froidObjectifsPratique Int? // Note 0-10

  // 6 (Froid) Recommandation
  recommandation Int? // Note 0-10

  // ===========================================
  // SECTION COMMENTAIRES
  // ===========================================
  suggestions String? @db.Text

  // ===========================================
  // SCORES CALCULÉS
  // ===========================================
  // Score moyen automatiquement calculé (moyenne de toutes les notes)
  scoreMoyen Float?

  // Score de satisfaction (note globale / 10 * 100)
  tauxSatisfaction Float?

  // ===========================================
  // METADATA TECHNIQUE
  // ===========================================
  ipAddress String?
  userAgent String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([evaluationId])
}

// ===========================================
// ÉVALUATION INTERVENANT (Qualiopi IND 2)
// ===========================================
// Évaluation par l'intervenant après chaque session

enum EvaluationIntervenantStatus {
  PENDING // En attente de complétion
  IN_PROGRESS // En cours de remplissage
  COMPLETED // Complété
  EXPIRED // Expiré
}

// Demande d'évaluation intervenant
model EvaluationIntervenant {
  id String @id @default(cuid())

  // Organisation (multi-tenant)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Session de formation liée
  sessionId String
  session   DocumentSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Intervenant concerné
  intervenantId String
  intervenant   Intervenant @relation("EvaluationIntervenantIntervenant", fields: [intervenantId], references: [id], onDelete: Cascade)

  // Token unique pour accès public (QR code / lien)
  token String @unique @default(cuid())

  // Statut
  status EvaluationIntervenantStatus @default(PENDING)

  // Dates
  expiresAt   DateTime? // Date d'expiration du lien
  sentAt      DateTime? // Date d'envoi à l'intervenant
  startedAt   DateTime? // Date de début de complétion
  completedAt DateTime? // Date de complétion

  // Réponse (stockée dans un modèle séparé)
  reponse EvaluationIntervenantReponse?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sessionId, intervenantId])
  @@index([organizationId])
  @@index([sessionId])
  @@index([intervenantId])
  @@index([token])
  @@index([status])
}

// Réponses détaillées à l'évaluation intervenant
model EvaluationIntervenantReponse {
  id String @id @default(cuid())

  // Évaluation parent
  evaluationId String                @unique
  evaluation   EvaluationIntervenant @relation(fields: [evaluationId], references: [id], onDelete: Cascade)

  // ===========================================
  // SECTION 2: ORGANISATION ET LOGISTIQUE
  // ===========================================
  // 2.1 Conditions matérielles et logistiques adaptées
  organisationConditions   Int? // Note 0-10
  // 2.2 Taille du groupe et niveau des participants adaptés
  organisationGroupe       Int? // Note 0-10
  // 2.3 Coordination avec l'organisme satisfaisante
  organisationCoordination Int? // Note 0-10
  // 2.4 Supports mis à disposition cohérents
  organisationSupports     Int? // Note 0-10

  // ===========================================
  // SECTION 3: CONTENU, MÉTHODES ET DYNAMIQUE
  // ===========================================
  // 3.1 Programme et objectifs réalistes et adaptés
  contenueObjectifs    Int? // Note 0-10
  // 3.2 Méthodes pédagogiques ont bien fonctionné
  contenuMethodes      Int? // Note 0-10
  // 3.3 Niveau de participation et engagement satisfaisant
  contenuParticipation Int? // Note 0-10

  // ===========================================
  // SECTION 4: ATTEINTE OBJECTIFS ET RESSENTI
  // ===========================================
  // 4.1 Objectifs pédagogiques atteints par le groupe
  objectifsAtteints   Int? // Note 0-10
  // 4.2 Valeur ajoutée apportée aux participants
  valeurAjoutee       Int? // Note 0-10
  // 4.3 Satisfaction globale du déroulement
  satisfactionGlobale Int? // Note 0-10

  // ===========================================
  // SECTION 5: SUGGESTIONS
  // ===========================================
  suggestions String? @db.Text

  // ===========================================
  // SCORES CALCULÉS
  // ===========================================
  scoreMoyen Float?

  // ===========================================
  // METADATA TECHNIQUE
  // ===========================================
  ipAddress String?
  userAgent String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([evaluationId])
}

// ===========================================
// ORGANIGRAMME (Qualiopi IND 9)
// ===========================================
// Structure organisationnelle de l'organisme de formation
// Permet d'afficher les responsables clés (référent handicap, pédagogique, etc.)

enum OrganigrammePosteType {
  DIRIGEANT // Gérant / Directeur
  REFERENT_HANDICAP // Référent handicap obligatoire Qualiopi
  REFERENT_PEDAGOGIQUE // Responsable pédagogique
  REFERENT_QUALITE // Référent qualité
  FORMATEUR // Formateur (lié à Intervenant)
  ADMINISTRATIF // Personnel administratif
  AUTRE // Autre poste personnalisé
}

model OrganigrammePoste {
  id String @id @default(cuid())

  // Type de poste
  type OrganigrammePosteType @default(AUTRE)

  // Titre du poste (ex: "Directeur Général", "Référent Handicap")
  titre String

  // Personne occupant le poste
  nom       String
  prenom    String
  email     String?
  telephone String?

  // Photo de profil (URL vers le fichier uploadé)
  photo String?

  // Description du rôle / missions
  description String? @db.Text

  // Lien optionnel vers un intervenant existant
  intervenantId String?
  intervenant   Intervenant? @relation("OrganigrammeIntervenant", fields: [intervenantId], references: [id], onDelete: SetNull)

  // Position hiérarchique
  niveau Int @default(0) // 0 = top, 1 = niveau 2, etc.
  ordre  Int @default(0) // Ordre dans le même niveau

  // Référence au supérieur hiérarchique (pour l'arbre)
  parentId String?
  parent   OrganigrammePoste?  @relation("OrganigrammeHierarchie", fields: [parentId], references: [id], onDelete: SetNull)
  children OrganigrammePoste[] @relation("OrganigrammeHierarchie")

  // Multi-tenant
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Visibilité
  isVisible Boolean @default(true) // Visible dans l'organigramme public

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([type])
  @@index([parentId])
  @@index([intervenantId])
}

// ===========================================
// PROCEDURES QUALITE - Qualiopi IND 26
// ===========================================

model Procedure {
  id String @id @default(cuid())

  // Type de procédure
  type ProcedureType

  // Nom personnalisé (si type = PERSONNALISEE)
  nom         String // Ex: "Procédure d'accueil des stagiaires"
  description String? @db.Text

  // Contenu de la procédure (format TipTap JSON)
  content Json?

  // Fichier PDF généré ou uploadé
  fileUrl  String?
  fileSize Int?

  // Référence au template utilisé
  templateId String?
  template   Template? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  // Versioning
  version        Int       @default(1)
  lastModifiedBy String? // userId qui a fait la dernière modification
  publishedAt    DateTime? // Date de publication officielle

  // Multi-tenant
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // État
  isActive    Boolean @default(true)
  isPublished Boolean @default(false) // true = visible dans les documents officiels

  // Historique des versions
  versions ProcedureVersion[]

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, type]) // Une seule procédure par type par organisation (sauf PERSONNALISEE)
  @@index([organizationId])
  @@index([type])
}

// Historique des versions d'une procédure
model ProcedureVersion {
  id String @id @default(cuid())

  // Référence à la procédure
  procedureId String
  procedure   Procedure @relation(fields: [procedureId], references: [id], onDelete: Cascade)

  // Contenu de cette version
  content Json
  version Int

  // Qui a créé cette version
  modifiedById   String?
  modifiedByName String?

  // Notes de modification
  changeNotes String? @db.Text

  // Metadata
  createdAt DateTime @default(now())

  @@index([procedureId])
  @@index([version])
}

// ===========================================
// VEILLE REGLEMENTAIRE - Qualiopi IND 23, 24, 25
// ===========================================

// Types de veille selon Qualiopi
enum VeilleType {
  LEGALE // IND 23 - Veille légale et réglementaire
  METIER // IND 24 - Veille métiers et compétences
  INNOVATION // IND 24 - Veille innovation pédagogique
  HANDICAP // IND 25 - Veille handicap et accessibilité
}

// Statut d'un article de veille
enum VeilleArticleStatus {
  NON_LU
  LU
  IMPORTANT
  ARCHIVE
}

// Source de veille (flux RSS, page web, document)
model VeilleSource {
  id String @id @default(cuid())

  // Type de veille concerné
  type VeilleType

  // Informations de la source
  nom         String // Ex: "Légifrance - Formation professionnelle"
  description String? @db.Text
  url         String // URL du flux RSS ou de la page à scraper
  logoUrl     String? // Logo de la source

  // Configuration de scraping
  isRss          Boolean @default(true) // true = flux RSS, false = scraping web
  scrapeSelector String? // Sélecteur CSS pour le scraping (si isRss = false)
  scrapeConfig   Json? // Configuration avancée du scraping

  // Fréquence de mise à jour
  refreshInterval Int       @default(1440) // En minutes (par défaut 24h = 1440 min)
  lastRefresh     DateTime?
  nextRefresh     DateTime?

  // État
  isActive   Boolean @default(true)
  errorCount Int     @default(0) // Compteur d'erreurs consécutives
  lastError  String? @db.Text

  // Multi-tenant (null = source globale pour tous)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Articles issus de cette source
  articles VeilleArticle[]

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([organizationId])
  @@index([isActive])
}

// Article/actualité récupéré depuis une source
model VeilleArticle {
  id String @id @default(cuid())

  // Source de l'article
  sourceId String
  source   VeilleSource @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  // Type de veille (copié depuis la source pour faciliter les requêtes)
  type VeilleType

  // Contenu de l'article
  titre    String
  resume   String? @db.Text // Résumé ou extrait
  contenu  String? @db.Text // Contenu complet (si disponible)
  url      String // URL de l'article original
  imageUrl String? // Image de couverture

  // Métadonnées
  auteur          String?
  datePublication DateTime
  tags            String[] @default([])

  // Analyse IA
  resumeIA       String?  @db.Text // Résumé généré par l'IA
  pointsCles     String[] @default([]) // Points clés extraits par l'IA
  impactQualiopi String?  @db.Text // Impact sur la conformité Qualiopi

  // Statut de lecture par organisation
  lecturesParOrg VeilleArticleLecture[]

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sourceId, url]) // Un article unique par source et URL
  @@index([type])
  @@index([sourceId])
  @@index([datePublication])
}

// Suivi de lecture des articles par organisation
model VeilleArticleLecture {
  id String @id @default(cuid())

  // Article concerné
  articleId String
  article   VeilleArticle @relation(fields: [articleId], references: [id], onDelete: Cascade)

  // Organisation qui a lu l'article
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Utilisateur qui a lu/marqué l'article
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Statut
  status VeilleArticleStatus @default(NON_LU)
  luAt   DateTime?
  notes  String?             @db.Text // Notes personnelles

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([articleId, organizationId])
  @@index([organizationId])
  @@index([articleId])
  @@index([status])
}

// Historique des conversations avec l'agent IA de veille
model VeilleConversation {
  id String @id @default(cuid())

  // Type de veille concerné
  type VeilleType

  // Organisation et utilisateur
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Historique des messages
  messages Json @default("[]") // [{role: "user"|"assistant", content: string, timestamp: string}]

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([userId])
  @@index([type])
}

// ===========================================
// RECLAMATIONS - Qualiopi IND 31
// ===========================================
// Gestion des réclamations et difficultés rencontrées

enum ReclamationOrigine {
  EMAIL
  TELEPHONE
  COURRIER
  FORMULAIRE
  AUTRE
}

enum ReclamationStatut {
  NOUVELLE // Réclamation reçue, pas encore traitée
  EN_ANALYSE // En cours d'analyse
  EN_COURS // Traitement en cours
  RESOLUE // Réclamation résolue
  CLOTUREE // Clôturée définitivement
}

enum ReclamationCategorie {
  PEDAGOGIE // Contenu, méthodes pédagogiques
  ORGANISATION // Planning, logistique
  ADMINISTRATIF // Documents, facturation
  TECHNIQUE // Problèmes techniques
  INTERVENANT // Formateur, animateur
  ACCESSIBILITE // Handicap, accessibilité
  AUTRE
}

model Reclamation {
  id String @id @default(cuid())

  // Multi-tenant
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Informations de la réclamation
  dateReclamation DateTime             @default(now())
  origine         ReclamationOrigine   @default(EMAIL)
  categorie       ReclamationCategorie @default(AUTRE)

  // Personne qui a émis la réclamation
  nomPlaignant       String
  emailPlaignant     String?
  telephonePlaignant String?
  typePlaignant      String? // "apprenant", "entreprise", "financeur", "autre"

  // Références optionnelles
  formationId String?
  formation   Formation? @relation(fields: [formationId], references: [id], onDelete: SetNull)
  sessionId   String?
  session     Session?   @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  apprenantId String?
  apprenant   Apprenant? @relation(fields: [apprenantId], references: [id], onDelete: SetNull)

  // Contenu de la réclamation
  objet       String // Sujet court
  description String @db.Text // Description détaillée du problème

  // Traitement
  statut             ReclamationStatut @default(NOUVELLE)
  datePriseEnCompte  DateTime? // Date de prise en compte
  analyse            String?           @db.Text // Analyse du problème
  actionsCorrectives String?           @db.Text // Actions correctives mises en place
  retourClient       String?           @db.Text // Réponse/retour fait au client
  dateRetourClient   DateTime?

  // Action préventive (lien avec améliorations)
  actionPreventive String?             @db.Text
  ameliorationId   String? // Lien vers une action d'amélioration créée
  amelioration     ActionAmelioration? @relation(fields: [ameliorationId], references: [id], onDelete: SetNull)

  // Suivi
  responsableId   String? // User responsable du traitement
  dateResolution  DateTime?
  delaiTraitement Int? // Délai en jours entre réception et résolution

  // Pièces jointes
  piecesJointes Json? // [{filename, url, type}]

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([statut])
  @@index([categorie])
  @@index([dateReclamation])
  @@index([formationId])
  @@index([sessionId])
}

// ===========================================
// AMELIORATIONS - Qualiopi IND 32
// ===========================================
// Plan d'amélioration continue basé sur les appréciations et réclamations

enum AmeliorationOrigine {
  RECLAMATION // Issue d'une réclamation
  EVALUATION_SATISFACTION // Issue d'une évaluation de satisfaction
  EVALUATION_INTERVENANT // Issue d'une évaluation formateur
  VEILLE // Issue de la veille réglementaire
  AUDIT // Issue d'un audit interne/externe
  INITIATIVE // Initiative interne d'amélioration
  AUTRE
}

enum AmeliorationStatut {
  A_FAIRE // Action planifiée
  EN_COURS // Action en cours de réalisation
  TERMINEE // Action terminée
  ANNULEE // Action annulée
  EN_ATTENTE // En attente (bloquée)
}

enum AmeliorationPriorite {
  BASSE
  MOYENNE
  HAUTE
  CRITIQUE
}

model ActionAmelioration {
  id String @id @default(cuid())

  // Multi-tenant
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Origine de l'amélioration
  origine        AmeliorationOrigine @default(INITIATIVE)
  origineDetails String?             @db.Text // Détails sur l'origine (ex: numéro réclamation, commentaire éval...)

  // Contenu de l'action
  titre       String // Titre court de l'action
  description String @db.Text // Description détaillée de l'amélioration

  // Domaine concerné
  domaine String? // Ex: "Pédagogie", "Organisation", "Administration", "Technique"

  // Planification
  priorite        AmeliorationPriorite @default(MOYENNE)
  responsableId   String? // User responsable de l'action
  responsableNom  String? // Nom du responsable (si pas user)
  dateCreation    DateTime             @default(now())
  echeance        DateTime? // Date d'échéance prévue
  dateDebut       DateTime? // Date de début effective
  dateRealisation DateTime? // Date de réalisation effective

  // Suivi
  statut     AmeliorationStatut @default(A_FAIRE)
  avancement Int                @default(0) // Pourcentage d'avancement 0-100

  // Résultats
  resultat         String? @db.Text // Description du résultat obtenu
  efficacite       String? @db.Text // Évaluation de l'efficacité de l'action
  indicateurMesure String? // Indicateur utilisé pour mesurer l'efficacité
  valeurAvant      String? // Valeur de l'indicateur avant l'action
  valeurApres      String? // Valeur de l'indicateur après l'action

  // Liens avec d'autres entités
  reclamations Reclamation[] // Réclamations liées à cette amélioration
  formationId  String? // Formation concernée (optionnel)
  formation    Formation?    @relation(fields: [formationId], references: [id], onDelete: SetNull)

  // Commentaires et historique
  commentaires  Json? // [{date, auteur, contenu}]
  piecesJointes Json? // [{filename, url, type}]

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([statut])
  @@index([priorite])
  @@index([origine])
  @@index([echeance])
  @@index([formationId])
}

// ===========================================
// MODULE 6 : MOTEUR D'AUTOMATISATION
// ===========================================

// Types de déclencheurs disponibles
enum WorkflowTriggerType {
  // Événements liés aux inscriptions
  PRE_INSCRIPTION // Nouvelle pré-inscription
  INSCRIPTION_SESSION // Inscription confirmée à une session

  // Événements temporels liés aux sessions
  SESSION_J_MOINS_7 // 7 jours avant début session
  SESSION_J_MOINS_1 // 1 jour avant début session
  SESSION_DEBUT // Début de session
  SESSION_FIN_JOURNEE // Fin de journée de formation
  SESSION_FIN // Fin de session
  SESSION_J_PLUS_30 // 30 jours après fin (éval à froid)

  // Événements liés aux évaluations
  EVALUATION_COMPLETEE // Évaluation complétée
  SCORE_INFERIEUR_SEUIL // Score inférieur à un seuil défini

  // Événements liés aux documents
  DOCUMENT_NON_SIGNE // Document non signé après X jours
  DOCUMENT_GENERE // Document généré
  SIGNATURE_RECUE // Signature reçue

  // Événements liés aux réclamations/qualité
  RECLAMATION_RECUE // Nouvelle réclamation
  AMELIORATION_CREEE // Nouvelle action d'amélioration

  // Planification personnalisée
  CRON // Exécution planifiée (cron expression)

  // Événements manuels
  MANUEL // Déclenché manuellement
}

// Types d'actions disponibles
enum WorkflowActionType {
  // Communication
  ENVOYER_EMAIL // Envoyer un email avec template
  ENVOYER_SMS // Envoyer un SMS

  // Documents
  GENERER_DOCUMENT // Générer un document PDF
  DEMANDER_SIGNATURE // Demander une signature électronique

  // Données
  METTRE_A_JOUR_CHAMP // Mettre à jour un champ
  CREER_APPRENANT // Créer un apprenant
  CREER_INSCRIPTION // Créer une inscription

  // Qualité Qualiopi
  CREER_RECLAMATION // Créer une réclamation
  CREER_AMELIORATION // Créer une action d'amélioration
  CREER_TACHE // Créer une tâche interne

  // Notifications
  NOTIFIER_EQUIPE // Notification in-app à l'équipe
  NOTIFIER_UTILISATEUR // Notification à un utilisateur spécifique

  // Intégrations externes
  WEBHOOK // Appeler un webhook externe
  APPEL_API // Appeler une API externe

  // Contrôle de flux
  DELAI // Attendre un délai
  CONDITION // Branchement conditionnel
  BOUCLE // Répéter une action
}

// Types de conditions disponibles
enum WorkflowConditionType {
  // Conditions sur les formations
  FORMATION_CERTIFIANTE // Si formation certifiante
  FORMATION_MODALITE // Si modalité = présentiel/distanciel/mixte

  // Conditions sur les évaluations
  SCORE_INFERIEUR // Si score < X
  SCORE_SUPERIEUR // Si score > X

  // Conditions sur les documents
  DOCUMENT_MANQUANT // Si document manquant
  SIGNATURE_EN_ATTENTE // Si signature en attente

  // Conditions sur les apprenants
  APPRENANT_HANDICAP // Si stagiaire en situation de handicap
  APPRENANT_FINANCEMENT // Si financé par type spécifique (OPCO, CPF, etc.)

  // Conditions personnalisées
  CHAMP_EGAL // Si champ = valeur
  CHAMP_CONTIENT // Si champ contient valeur
  CHAMP_VIDE // Si champ est vide
  CHAMP_NON_VIDE // Si champ n'est pas vide
  FORMULE_PERSONNALISEE // Condition avec formule personnalisée
}

// Statut d'exécution d'un workflow
enum WorkflowExecutionStatus {
  EN_ATTENTE // En attente d'exécution (délai, condition)
  EN_COURS // En cours d'exécution
  PAUSE // Mis en pause (attente délai, événement)
  TERMINEE // Exécution terminée avec succès
  ERREUR // Exécution terminée avec erreur
  ANNULEE // Exécution annulée
}

// Catégories de workflows pour l'organisation
enum WorkflowCategory {
  INSCRIPTION // Parcours inscription
  SESSION // Gestion des sessions
  EVALUATION // Évaluations et enquêtes
  DOCUMENT // Gestion documentaire
  QUALITE // Réclamations et améliorations
  COMMUNICATION // Communications générales
  PERSONNALISE // Workflows personnalisés
}

// Workflow (automatisation)
model Workflow {
  id             String           @id @default(cuid())
  organizationId String
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Informations de base
  nom         String // Nom du workflow
  description String?            @db.Text // Description du workflow
  icone       String? // Emoji ou icône du workflow
  categorie   WorkflowCategory   @default(PERSONNALISE)

  // Activation
  actif Boolean @default(true) // Workflow activé ou non

  // Déclencheur
  triggerType   WorkflowTriggerType // Type de déclencheur
  triggerConfig Json? // Configuration spécifique au trigger (ex: seuil score, délai, cron)

  // Statistiques
  nombreExecutions       Int       @default(0) // Nombre total d'exécutions
  derniereDeclenchement  DateTime? // Date du dernier déclenchement
  nombreErreurs          Int       @default(0) // Nombre d'erreurs

  // Template pré-configuré
  estTemplate    Boolean @default(false) // Est un template système
  templateSource String? // ID du template source si cloné

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  etapes     WorkflowEtape[]
  executions WorkflowExecution[]
  logs       WorkflowLog[]

  @@index([organizationId])
  @@index([actif])
  @@index([triggerType])
  @@index([categorie])
}

// Étape d'un workflow
model WorkflowEtape {
  id         String   @id @default(cuid())
  workflowId String
  workflow   Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  // Position dans le workflow
  ordre Int @default(0) // Ordre d'exécution

  // Type et configuration
  type   WorkflowActionType // Type d'action
  config Json // Configuration de l'action (template email, délai, webhook URL, etc.)

  // Nom et description pour l'UI
  nom         String? // Nom de l'étape pour l'affichage
  description String? // Description pour l'affichage

  // Position visuelle pour l'éditeur
  positionX Float @default(0)
  positionY Float @default(0)

  // Conditions d'exécution (optionnel)
  conditions Json? // [{type, config, operator}] - AND/OR entre conditions

  // Étape suivante (pour branchements)
  etapeSuivanteId     String? // ID étape suivante (défaut)
  etapeSuivanteOuiId  String? // ID étape si condition vraie
  etapeSuivanteNonId  String? // ID étape si condition fausse

  // Gestion des erreurs
  continuerSurErreur Boolean @default(false) // Continuer si erreur
  nombreReessais     Int     @default(0) // Nombre de réessais en cas d'erreur
  delaiReessai       Int     @default(60) // Délai entre réessais (secondes)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  executionsEtapes WorkflowExecutionEtape[]

  @@index([workflowId])
  @@index([ordre])
}

// Exécution d'un workflow
model WorkflowExecution {
  id         String   @id @default(cuid())
  workflowId String
  workflow   Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  // Contexte du déclenchement
  declencheurType   String? // Type d'entité déclencheuse
  declencheurId     String? // ID de l'entité déclencheuse
  declencheurData   Json? // Données du contexte au moment du déclenchement

  // Statut d'exécution
  statut        WorkflowExecutionStatus @default(EN_ATTENTE)
  etapeActuelle Int                     @default(0) // Index de l'étape en cours
  progression   Int                     @default(0) // Pourcentage de progression (0-100)

  // Planification (pour délais et CRON)
  prochaineExecution DateTime? // Prochaine exécution planifiée
  delaiRestant       Int? // Délai restant en secondes (pour affichage)

  // Résultats
  resultats Json? // Résultats de chaque étape
  erreur    String?   @db.Text // Message d'erreur si échec
  logs      Json? // Logs détaillés de l'exécution

  // Timing
  debutAt DateTime  @default(now())
  finAt   DateTime?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  etapesExecution WorkflowExecutionEtape[]

  @@index([workflowId])
  @@index([statut])
  @@index([prochaineExecution])
  @@index([debutAt])
}

// Exécution d'une étape spécifique
model WorkflowExecutionEtape {
  id          String            @id @default(cuid())
  executionId String
  execution   WorkflowExecution @relation(fields: [executionId], references: [id], onDelete: Cascade)
  etapeId     String
  etape       WorkflowEtape     @relation(fields: [etapeId], references: [id], onDelete: Cascade)

  // Statut
  statut    WorkflowExecutionStatus @default(EN_ATTENTE)
  tentative Int                     @default(1) // Numéro de tentative

  // Entrées/Sorties
  entrees Json? // Données d'entrée de l'étape
  sorties Json? // Données de sortie de l'étape

  // Erreur
  erreur String? @db.Text // Message d'erreur si échec

  // Timing
  debutAt DateTime?
  finAt   DateTime?

  // Metadata
  createdAt DateTime @default(now())

  @@index([executionId])
  @@index([etapeId])
  @@index([statut])
}

// Logs des workflows (pour historique et debug)
model WorkflowLog {
  id         String   @id @default(cuid())
  workflowId String
  workflow   Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  // Informations du log
  niveau  String // info, warning, error, debug
  message String   @db.Text
  details Json? // Détails supplémentaires

  // Contexte
  executionId String? // ID de l'exécution associée
  etapeId     String? // ID de l'étape associée

  // Metadata
  createdAt DateTime @default(now())

  @@index([workflowId])
  @@index([niveau])
  @@index([createdAt])
  @@index([executionId])
}

// Templates d'emails pour les workflows
model WorkflowEmailTemplate {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Informations
  nom         String // Nom du template
  description String? // Description
  sujet       String // Sujet de l'email
  contenu     String  @db.Text // Contenu HTML/Markdown de l'email

  // Variables disponibles
  variables Json? // [{nom, description, exemple}]

  // Catégorie
  categorie String? // Ex: "inscription", "rappel", "evaluation"

  // Template système ou personnalisé
  estSysteme Boolean @default(false)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([categorie])
}

// Templates de SMS pour les workflows
model WorkflowSMSTemplate {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Informations
  nom         String // Nom du template
  description String? // Description
  contenu     String  @db.Text // Contenu du SMS (max 160 chars par segment)

  // Variables disponibles
  variables Json? // [{nom, description, exemple}]

  // Template système ou personnalisé
  estSysteme Boolean @default(false)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
}

// ===========================================
// QUALIOPI - MODULE 7 & 8
// ===========================================

// Audit Qualiopi - Représente un audit (réel ou simulation)
model AuditQualiopi {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Informations audit
  type          AuditType     // INITIAL, SURVEILLANCE, RENOUVELLEMENT, SIMULATION
  dateAudit     DateTime      // Date de l'audit
  auditeur      String?       // Nom de l'auditeur/organisme certificateur
  resultat      AuditResultat @default(EN_ATTENTE)

  // Scores
  scoreGlobal         Float?   @default(0) // Score global en pourcentage
  indicateursConformes Int?    @default(0)
  indicateursTotal     Int?    @default(32)

  // Notes et observations
  notes         String?  @db.Text
  pointsForts   Json?    // [{critere, description}]
  pointsAmeliorer Json?  // [{critere, description, priorite}]

  // Rapport
  rapportUrl    String?

  // Relations
  indicateurs   AuditIndicateur[]

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([dateAudit])
  @@index([type])
}

// État de conformité d'un indicateur pour un audit
model AuditIndicateur {
  id       String        @id @default(cuid())
  auditId  String
  audit    AuditQualiopi @relation(fields: [auditId], references: [id], onDelete: Cascade)

  // Indicateur
  numeroIndicateur Int           // 1 à 32
  critere          Int           // 1 à 7
  status           IndicateurStatus @default(A_EVALUER)

  // Évaluation
  note             String?  @db.Text // Note de l'auditeur
  preuvesFournies  Json?    // [{type, description, documentId}]
  actionsRequises  Json?    // [{description, priorite, deadline}]

  // Score partiel (0-100)
  score            Float?   @default(0)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([auditId, numeroIndicateur])
  @@index([auditId])
  @@index([numeroIndicateur])
  @@index([status])
}

// Conformité en temps réel d'un indicateur (suivi continu)
model IndicateurConformite {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Indicateur
  numeroIndicateur Int              // 1 à 32
  critere          Int              // 1 à 7
  libelle          String           // Nom de l'indicateur
  description      String?  @db.Text

  // Statut actuel
  status           IndicateurStatus @default(A_EVALUER)
  score            Float            @default(0) // Score de conformité 0-100

  // Détails
  derniereEvaluation DateTime?
  prochainControle   DateTime?
  notes              String?  @db.Text

  // Preuves associées
  preuves   PreuveIndicateur[]

  // Actions correctives
  actions   ActionCorrective[]

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, numeroIndicateur])
  @@index([organizationId])
  @@index([status])
  @@index([critere])
}

// Preuve pour un indicateur
model PreuveIndicateur {
  id           String               @id @default(cuid())
  indicateurId String
  indicateur   IndicateurConformite @relation(fields: [indicateurId], references: [id], onDelete: Cascade)

  // Type de preuve
  type         String    // document, processus, donnee, temoignage
  nom          String
  description  String?

  // Source de la preuve
  sourceType   String?   // formation, session, apprenant, evaluation, document
  sourceId     String?   // ID de la source (formationId, sessionId, etc.)

  // Document associé (optionnel)
  documentId   String?   // Référence vers GeneratedDocument ou autre

  // Validité
  dateValidite DateTime?
  estValide    Boolean   @default(true)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([indicateurId])
  @@index([type])
  @@index([sourceType, sourceId])
}

// Action corrective pour un indicateur
model ActionCorrective {
  id           String               @id @default(cuid())
  indicateurId String
  indicateur   IndicateurConformite @relation(fields: [indicateurId], references: [id], onDelete: Cascade)

  // Informations
  titre        String
  description  String?  @db.Text
  priorite     AlertePriorite @default(MOYENNE)
  status       ActionCorrectiveStatus @default(A_FAIRE)

  // Responsable
  responsableId String?
  responsable   User?    @relation(fields: [responsableId], references: [id])

  // Dates
  dateEcheance DateTime?
  dateRealisation DateTime?

  // Notes
  notesProgres String?  @db.Text

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([indicateurId])
  @@index([status])
  @@index([dateEcheance])
}

// Alerte Qualiopi
model AlerteQualiopi {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Type et priorité
  type           AlerteQualiopiType
  priorite       AlertePriorite @default(MOYENNE)

  // Contenu
  titre          String
  message        String  @db.Text
  indicateur     Int?    // Numéro de l'indicateur concerné (1-32)

  // Statut
  estLue         Boolean @default(false)
  estResolue     Boolean @default(false)
  dateResolution DateTime?

  // Lien vers ressource
  lienType       String?  // indicateur, document, action, audit
  lienId         String?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([type])
  @@index([estLue])
  @@index([estResolue])
  @@index([priorite])
}

// Historique des conversations avec l'Agent IA Qualiopi
model ConversationQualiopi {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Titre de la conversation (généré ou personnalisé)
  titre          String?

  // Messages
  messages       MessageQualiopi[]

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([userId])
}

// Message dans une conversation avec l'Agent IA
model MessageQualiopi {
  id             String              @id @default(cuid())
  conversationId String
  conversation   ConversationQualiopi @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  // Message
  role           String   // "user" ou "assistant"
  contenu        String   @db.Text

  // Contexte utilisé par l'IA
  contexte       Json?    // Données utilisées pour générer la réponse

  // Indicateurs mentionnés
  indicateursMentionnes Int[] // Liste des numéros d'indicateurs

  // Feedback
  feedback       String?  // "positive", "negative", null

  // Metadata
  createdAt DateTime @default(now())

  @@index([conversationId])
  @@index([role])
}

// Bilan Pédagogique et Financier (BPF)
model BilanPedagogiqueFinancier {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Année concernée
  annee          Int

  // Section A - Identification
  sectionA       Json?

  // Section B - Bilan d'activité
  nombreStagiaires        Int?
  nombreHeuresFormation   Int?
  nombreActions           Int?

  // Section C - Données financières
  chiffreAffaires         Float?
  chargesExploitation     Float?
  resultatNet             Float?

  // Section D - Répartition
  repartitionPublic       Json?  // Par type de public
  repartitionFinancement  Json?  // Par type de financement
  repartitionDomaine      Json?  // Par domaine de formation

  // Statut
  estSoumis      Boolean  @default(false)
  dateSoumission DateTime?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, annee])
  @@index([organizationId])
  @@index([annee])
}
